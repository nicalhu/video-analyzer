<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½æµ‹è¯•ç”¨ä¾‹è¯„å®¡åŠ©æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-dark: #1E1B4B;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Header */
        .header {
            background: var(--bg-gradient);
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            color: white;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            min-height: calc(100vh - 180px);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* File Upload */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #F9FAFB;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .upload-text {
            color: var(--text-dark);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: var(--text-light);
            font-size: 12px;
        }

        .file-info {
            margin-top: 15px;
            padding: 12px;
            background: #F0FDF4;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .file-info-item:last-child {
            margin-bottom: 0;
        }

        .file-info-label {
            color: var(--text-light);
        }

        .file-info-value {
            color: var(--text-dark);
            font-weight: 500;
        }

        .file-status {
            color: var(--success);
        }

        /* Quick Review */
        .review-btn {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: white;
        }

        .review-btn:last-child {
            margin-bottom: 0;
        }

        .review-btn.boundary {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
        }

        .review-btn.ambiguity {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
        }

        .review-btn.format {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }

        .review-btn.custom {
            background: linear-gradient(135deg, #EC4899 0%, #F472B6 100%);
        }

        .review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .review-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Chat Area */
        .chat-container {
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(180deg, #F8FAFC 0%, #FFFFFF 100%);
            min-height: 500px;
            max-height: calc(100vh - 380px);
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-user .message-content {
            background: var(--bg-gradient);
            color: white;
            border-radius: 16px 16px 4px 16px;
            max-width: 70%;
        }

        .message-ai {
            display: flex;
            justify-content: flex-start;
        }

        .message-ai .message-content {
            background: white;
            color: var(--text-dark);
            border-radius: 16px 16px 16px 4px;
            max-width: 85%;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .message-content {
            padding: 14px 18px;
            font-size: 14px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message-ai .message-content strong {
            color: var(--primary);
        }

        /* Chat Input */
        .chat-input-container {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 12px;
            background: var(--bg-gradient);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Status Bar */
        .status-bar {
            padding: 10px 20px;
            background: #F8FAFC;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.disconnected {
            background: var(--danger);
        }

        .status-dot.loading {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 24px;
            background: var(--bg-gradient);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(80vh - 140px);
        }

        .modal-footer {
            padding: 16px 24px;
            background: #F9FAFB;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #F3F4F6;
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #E5E7EB;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Review Type List */
        .review-type-item {
            padding: 16px;
            background: #F9FAFB;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }

        .review-type-item:last-child {
            margin-bottom: 0;
        }

        .review-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-type-name {
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-type-name .default-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
        }

        .review-type-desc {
            font-size: 13px;
            color: var(--text-light);
        }

        .review-type-actions {
            display: flex;
            gap: 8px;
        }

        .review-type-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Help Content */
        .help-section {
            margin-bottom: 24px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section h4 {
            color: var(--primary);
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section ul {
            padding-left: 20px;
            color: var(--text-dark);
        }

        .help-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        /* Loading */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 20px;
            background: #1F2937;
            color: white;
            border-radius: 10px;
            font-size: 14px;
            z-index: 2000;
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.warning {
            background: var(--warning);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes toastIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .chat-container {
                order: 1;
            }

            .chat-messages {
                min-height: 400px;
                max-height: 50vh;
            }
        }

        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F1F1;
        }

        ::-webkit-scrollbar-thumb {
            background: #C1C1C1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #A1A1A1;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½ç”¨ä¾‹è¯„å®¡ç³»ç»Ÿ</h1>
        <p>æ”¯æŒ DeepSeek å’Œ åƒé—®(Qianwen) çš„æ™ºèƒ½æµ‹è¯•ç”¨ä¾‹è¯„å®¡åŠ©æ‰‹</p>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="toolbar-btn" onclick="showModal('apiModal')">ğŸ”‘ APIé…ç½®</button>
        <button class="toolbar-btn" onclick="showModal('reviewTypesModal')">ğŸ“‹ å¿«é€Ÿè¯„å®¡é…ç½®ç®¡ç†</button>
        <button class="toolbar-btn" onclick="downloadExcelTemplate()">ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿</button>
        <button class="toolbar-btn" onclick="exportChat()">ğŸ“¤ å¯¼å‡ºå¯¹è¯</button>
        <button class="toolbar-btn" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
        <button class="toolbar-btn" onclick="showModal('helpModal')">ğŸ’¡ å¸®åŠ©</button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- File Upload -->
            <div class="card">
                <div class="card-title">ğŸ“ æ–‡ä»¶ä¸Šä¼ </div>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“„</div>
                    <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                    <div class="upload-hint">æ”¯æŒ .txtã€.xmind å’Œ .xlsx/.xls æ ¼å¼</div>
                </div>
                <input type="file" id="fileInput" accept=".txt,.xmind,.xml,.xlsx,.xls" onchange="handleFileSelect(event)">
                <div class="file-info" id="fileInfo" style="display: none;">
                    <div class="file-info-item">
                        <span class="file-info-label">æ–‡ä»¶åï¼š</span>
                        <span class="file-info-value" id="fileName"></span>
                    </div>
                    <div class="file-info-item">
                        <span class="file-info-label">å¤§å°ï¼š</span>
                        <span class="file-info-value" id="fileSize"></span>
                    </div>
                    <div class="file-info-item">
                        <span class="file-info-label">çŠ¶æ€ï¼š</span>
                        <span class="file-info-value file-status" id="fileStatus">âœ“ å·²åŠ è½½</span>
                    </div>
                    <div class="file-info-item">
                        <span class="file-info-label">å†…å®¹ï¼š</span>
                        <span class="file-info-value" id="fileContentLength"></span>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; font-size: 12px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; border: 1px solid #E5E7EB;">
                        <div style="color: #6B7280; margin-bottom: 5px; font-weight: 500;">ğŸ“„ å†…å®¹é¢„è§ˆï¼š</div>
                        <div id="fileContentPreview" style="color: #1F2937; line-height: 1.5;"></div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button onclick="changeFile()" style="flex: 1; padding: 8px 12px; border: 2px solid #6366F1; background: white; color: #6366F1; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                            ğŸ”„ æ›´æ¢æ–‡ä»¶
                        </button>
                        <button onclick="clearCurrentFile()" style="flex: 1; padding: 8px 12px; border: 2px solid #EF4444; background: white; color: #EF4444; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                            ğŸ—‘ï¸ æ¸…é™¤æ–‡ä»¶
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Review -->
            <div class="card">
                <div class="card-title">âš¡ å¿«é€Ÿè¯„å®¡</div>
                <div id="quickReviewButtons">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message message-ai">
                    <div class="message-content">
ğŸ‘‹ <strong>æ¬¢è¿ä½¿ç”¨AIæ™ºèƒ½æµ‹è¯•ç”¨ä¾‹è¯„å®¡åŠ©æ‰‹ï¼</strong>

æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ï¼š
â€¢ ğŸ“„ åˆ†æä¸Šä¼ çš„æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ï¼ˆ.txtã€.xmind æˆ– .xlsx/.xlsï¼‰
â€¢ ğŸ” è¿›è¡Œè¾¹ç•Œå€¼è¯„å®¡ã€äºŒä¹‰æ€§æ£€æŸ¥ã€æ ¼å¼è§„èŒƒåŒ–æ£€æŸ¥
â€¢ ğŸ’¬ å›ç­”å…³äºæµ‹è¯•ç”¨ä¾‹çš„ä»»ä½•é—®é¢˜

<strong>å¿«é€Ÿå¼€å§‹ï¼š</strong>
1. ç‚¹å‡»ã€ŒğŸ”‘ APIé…ç½®ã€é…ç½®æ‚¨çš„ API Keyï¼ˆæ”¯æŒ DeepSeek æˆ– åƒé—®ï¼‰
2. ä¸Šä¼ æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶
3. é€‰æ‹©å¿«é€Ÿè¯„å®¡ç±»å‹æˆ–ç›´æ¥è¾“å…¥é—®é¢˜

æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</div>
                </div>
            </div>

            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–è¯„å®¡è¦æ±‚..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
            </div>

            <div class="status-bar">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">æœåŠ¡çŠ¶æ€: æœªé…ç½®API Key</span>
                <span style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                    <span id="fileStatusBar"></span>
                    <select class="form-select" id="activeModelSelect" style="padding: 4px 8px; font-size: 12px; width: auto; border: 1px solid #D1D5DB;" onchange="updateActiveModel()">
                        <option value="deepseek">ğŸ”µ DeepSeek</option>
                        <option value="qianwen">ğŸŸ£ åƒé—®</option>
                    </select>
                </span>
            </div>
        </div>
    </div>

    <!-- API Config Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ”‘ APIé…ç½®</h3>
                <button class="modal-close" onclick="closeModal('apiModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="background: #F0F9FF; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #0369A1;">ğŸ’¡ é…ç½®è¯´æ˜</h4>
                    <p style="margin: 0; font-size: 13px; color: #475569;">è¯·åˆ†åˆ«é…ç½® DeepSeek å’Œåƒé—®çš„ API Keyï¼Œè¯„å®¡æ—¶å¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ¨¡å‹</p>
                </div>

                <!-- DeepSeek é…ç½® -->
                <div style="border: 2px solid #E0E7FF; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 18px;">ğŸ”µ</span>
                        <h4 style="margin: 0; font-size: 15px; color: #4F46E5;">DeepSeek API</h4>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="deepseekApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                        <div class="form-hint">è·å–åœ°å€: <a href="https://platform.deepseek.com" target="_blank">https://platform.deepseek.com</a></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">é»˜è®¤æ¨¡å‹</label>
                        <select class="form-select" id="deepseekModel">
                            <option value="deepseek-chat">deepseek-chat V3.1 (æœ€æ–°é€šç”¨æ¨¡å‹)</option>
                            <option value="deepseek-reasoner">deepseek-reasoner (æ¨ç†å¢å¼º)</option>
                        </select>
                    </div>
                </div>

                <!-- åƒé—®é…ç½® -->
                <div style="border: 2px solid #DBEAFE; border-radius: 12px; padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 18px;">ğŸŸ£</span>
                        <h4 style="margin: 0; font-size: 15px; color: #7C3AED;">åƒé—® (Qianwen) API</h4>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">API ç«¯ç‚¹</label>
                        <input type="text" class="form-input" id="qianwenApiUrl" value="http://43.173.153.29:11436/v1/chat/completions">
                        <div class="form-hint">é»˜è®¤: http://43.173.153.29:11436/v1/chat/completions (ä½ çš„æœåŠ¡å™¨)</div>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="qianwenApiKey" placeholder="xxx">
                        <div class="form-hint">è¯·è¾“å…¥ä½ çš„ API Key</div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">é»˜è®¤æ¨¡å‹</label>
                        <input type="text" class="form-input" id="qianwenModel" value="Qwen3-32B-AWQ">
                        <div class="form-hint">é»˜è®¤: Qwen3-32B-AWQ | å…¶ä»–å¯é€‰: qwen-max, qwen-plus, qwen-long</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="testConnection('deepseek')">ğŸ”— æµ‹è¯• DeepSeek</button>
                <button class="btn btn-secondary" onclick="testConnection('qianwen')">ğŸ”— æµ‹è¯•åƒé—®</button>
                <button class="btn btn-primary" onclick="saveApiConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Review Types Modal -->
    <div class="modal-overlay" id="reviewTypesModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ğŸ“‹ å¿«é€Ÿè¯„å®¡é…ç½®ç®¡ç†</h3>
                <button class="modal-close" onclick="closeModal('reviewTypesModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showAddReviewType()">âœ¨ æ–°å»ºè¯„å®¡ç±»å‹</button>
                    <button class="btn btn-secondary" onclick="resetDefaultTypes()">ğŸ”„ é‡ç½®é»˜è®¤ç±»å‹</button>
                    <button class="btn btn-secondary" onclick="exportConfig()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                    <button class="btn btn-secondary" onclick="importConfig()">ğŸ“¥ å¯¼å…¥é…ç½®</button>
                </div>
                <div id="reviewTypesList">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('reviewTypesModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Review Type Modal -->
    <div class="modal-overlay" id="editTypeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="editTypeTitle">âœ¨ æ–°å»ºè¯„å®¡ç±»å‹</h3>
                <button class="modal-close" onclick="closeModal('editTypeModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è¯„å®¡ç±»å‹åç§°</label>
                    <input type="text" class="form-input" id="typeNameInput" placeholder="ä¾‹å¦‚ï¼šæ€§èƒ½æµ‹è¯•è¯„å®¡">
                </div>
                <div class="form-group">
                    <label class="form-label">å›¾æ ‡ (Emoji)</label>
                    <input type="text" class="form-input" id="typeIconInput" placeholder="ä¾‹å¦‚ï¼šğŸš€" style="width: 100px;">
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <input type="text" class="form-input" id="typeDescInput" placeholder="ç®€çŸ­æè¿°è¯¥è¯„å®¡ç±»å‹çš„ç”¨é€”">
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt æ¨¡æ¿</label>
                    <textarea class="form-input form-textarea" id="typePromptInput" placeholder="è¾“å…¥è¯„å®¡æ—¶ä½¿ç”¨çš„ Prompt..."></textarea>
                    <div class="form-hint">ä½¿ç”¨ {content} ä½œä¸ºæµ‹è¯•ç”¨ä¾‹å†…å®¹çš„å ä½ç¬¦</div>
                </div>
                <div class="form-group">
                    <label class="form-label">æŒ‰é’®é¢œè‰²</label>
                    <select class="form-select" id="typeColorInput">
                        <option value="boundary">ç´«è‰² (è¾¹ç•Œå€¼)</option>
                        <option value="ambiguity">ç»¿è‰² (äºŒä¹‰æ€§)</option>
                        <option value="format">æ©™è‰² (æ ¼å¼)</option>
                        <option value="custom">ç²‰è‰² (è‡ªå®šä¹‰)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editTypeModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveReviewType()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ’¡ å¸®åŠ©</h3>
                <button class="modal-close" onclick="closeModal('helpModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h4>ğŸš€ å¿«é€Ÿå¼€å§‹</h4>
                    <ul>
                        <li>é¦–å…ˆé…ç½® DeepSeek æˆ– åƒé—® API Key</li>
                        <li>ä¸Šä¼ æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ï¼ˆ.txtã€.xmind æˆ– .xlsx/.xls æ ¼å¼ï¼‰</li>
                        <li>é€‰æ‹©å¿«é€Ÿè¯„å®¡ç±»å‹æˆ–ç›´æ¥å¯¹è¯</li>
                        <li>æŸ¥çœ‹ AI ç”Ÿæˆçš„è¯„å®¡å»ºè®®</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>ğŸ“‹ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h4>
                    <ul>
                        <li><strong>.txt</strong> - çº¯æ–‡æœ¬æ ¼å¼çš„æµ‹è¯•ç”¨ä¾‹</li>
                        <li><strong>.xmind</strong> - XMind æ€ç»´å¯¼å›¾æ ¼å¼</li>
                        <li><strong>.xlsx / .xls</strong> - Excel è¡¨æ ¼æ ¼å¼
                            <ul style="margin-top: 5px;">
                                <li>ğŸ“¥ ç‚¹å‡»"ä¸‹è½½Excelæ¨¡æ¿"è·å–æ ‡å‡†æ¨¡æ¿</li>
                                <li>ğŸ“Š ä¸Šä¼ åéœ€é…ç½®å­—æ®µæ˜ å°„å…³ç³»</li>
                                <li>âš ï¸ å¿…é¡»åŒ…å«ï¼šå‰ç½®æ¡ä»¶ã€æ“ä½œæ­¥éª¤ã€é¢„æœŸç»“æœ</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>âš¡ å¿«é€Ÿè¯„å®¡ç±»å‹</h4>
                    <ul>
                        <li><strong>è¾¹ç•Œå€¼è¯„å®¡</strong> - æ£€æŸ¥è¾¹ç•Œå€¼æµ‹è¯•çš„å®Œæ•´æ€§</li>
                        <li><strong>äºŒä¹‰æ€§æ£€æŸ¥</strong> - è¯†åˆ«ç”¨ä¾‹æè¿°ä¸­çš„æ­§ä¹‰</li>
                        <li><strong>æ ¼å¼è§„èŒƒåŒ–æ£€æŸ¥</strong> - éªŒè¯ç”¨ä¾‹æ ¼å¼è§„èŒƒæ€§</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>ğŸ’¡ ä½¿ç”¨æŠ€å·§</h4>
                    <ul>
                        <li>ğŸ“¥ <strong>Excel ç”¨æˆ·</strong>ï¼šå…ˆä¸‹è½½æ¨¡æ¿ï¼ŒæŒ‰æ¨¡æ¿æ ¼å¼ç¼–å†™ç”¨ä¾‹</li>
                        <li>ğŸ“Š <strong>è‡ªå®šä¹‰ Excel</strong>ï¼šä¸Šä¼ ååœ¨å¼¹çª—ä¸­é…ç½®å­—æ®µæ˜ å°„</li>
                        <li>ğŸ”§ å¯ä»¥è‡ªå®šä¹‰è¯„å®¡ç±»å‹å’Œæç¤ºè¯</li>
                        <li>ğŸ“¤ æ”¯æŒå¯¼å‡ºå’Œå¯¼å…¥è¯„å®¡é…ç½®</li>
                        <li>ğŸ’¾ å¯ä»¥å¯¼å‡ºå®Œæ•´çš„å¯¹è¯è®°å½•</li>
                        <li>ğŸ’¬ æ”¯æŒè¿ç»­å¯¹è¯å’Œä¸Šä¸‹æ–‡ç†è§£</li>
                        <li>ğŸ”„ åŒä¸€æ–‡ä»¶å¯è¿›è¡Œå¤šç§ç±»å‹çš„è¿ç»­è¯„å®¡</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('helpModal')">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- Excel å­—æ®µæ˜ å°„é…ç½®å¼¹çª— -->
    <div class="modal-overlay" id="excelMappingModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ğŸ“Š Excel å­—æ®µæ˜ å°„é…ç½®</h3>
                <button class="modal-close" onclick="closeModal('excelMappingModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="background: #FEF3C7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #F59E0B;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 20px;">âš ï¸</span>
                        <strong style="color: #92400E;">é‡è¦è¯´æ˜</strong>
                    </div>
                    <p style="margin: 0; font-size: 13px; color: #78350F;">
                        è¯·å°† Excel è¡¨æ ¼ä¸­çš„åˆ—æ˜ å°„åˆ°å¯¹åº”çš„ç”¨ä¾‹å­—æ®µã€‚<br>
                        <strong style="color: #D97706;">å‰ç½®æ¡ä»¶ã€æ“ä½œæ­¥éª¤ã€é¢„æœŸç»“æœ</strong> ä¸ºå¿…é€‰å­—æ®µï¼Œå¿…é¡»æ˜ å°„ï¼
                    </p>
                </div>

                <div style="background: #F9FAFB; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #6B7280; margin-bottom: 10px;">
                        ğŸ“„ æ–‡ä»¶å: <strong id="excelFileName" style="color: #1F2937;"></strong>
                    </div>
                    <div style="font-size: 13px; color: #6B7280;">
                        ğŸ“‹ æ£€æµ‹åˆ°çš„åˆ—: <strong id="excelHeaderCount" style="color: #1F2937;"></strong>
                    </div>
                </div>

                <div id="fieldMappingContainer" style="display: grid; gap: 16px;">
                    <!-- åŠ¨æ€ç”Ÿæˆå­—æ®µæ˜ å°„é€‰æ‹©å™¨ -->
                </div>

                <div style="margin-top: 20px; padding: 12px; background: #EFF6FF; border-radius: 8px; border-left: 4px solid #3B82F6;">
                    <div style="font-size: 13px; color: #1E40AF;">
                        ğŸ’¡ <strong>æç¤ºï¼š</strong>å¦‚æœæŸä¸ªå­—æ®µåœ¨æ‚¨çš„ Excel ä¸­ä¸å­˜åœ¨ï¼Œå¯ä»¥é€‰æ‹©"ä¸æ˜ å°„"
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('excelMappingModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmExcelMapping()">âœ… ç¡®è®¤æ˜ å°„å¹¶è§£æ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½®å’ŒçŠ¶æ€ ====================
        const CONFIG_KEY = 'ai_review_config';
        const REVIEW_TYPES_KEY = 'ai_review_types';
        const CHAT_HISTORY_KEY = 'ai_chat_history';

        let currentFile = null;
        let fileContent = '';
        let chatHistory = [];
        let editingTypeId = null;
        let activeModel = 'deepseek'; // å½“å‰æ¿€æ´»çš„æ¨¡å‹
        let currentFileReviewHistory = []; // å½“å‰æ–‡ä»¶çš„è¯„å®¡å†å² [{typeId, typeName, timestamp}]
        let excelRawData = null; // Excel åŸå§‹æ•°æ® {headers: [], rows: []}
        let excelFieldMapping = null; // Excel å­—æ®µæ˜ å°„é…ç½®
        
        // æ¨¡å‹çš„ token é™åˆ¶é…ç½®ï¼ˆå­—ç¬¦æ•°è¿‘ä¼¼å€¼ï¼‰
        const MODEL_LIMITS = {
            'deepseek-chat': 32000,      // DeepSeek Chat æ”¯æŒ 32K tokens
            'deepseek-reasoner': 32000,  
            'qwen-max': 28000,           // åƒé—® max æ”¯æŒçº¦ 30K tokensï¼Œä¿å®ˆä¼°è®¡ 28K
            'qwen-plus': 28000,
            'qwen-turbo': 6000,          // åƒé—® turbo æ”¯æŒ 8K tokensï¼Œä¿å®ˆä¼°è®¡ 6K
            'qwen-long': 1000000         // åƒé—® long æ”¯æŒè¶…é•¿æ–‡æœ¬
        };

        // é»˜è®¤è¯„å®¡ç±»å‹
        const DEFAULT_REVIEW_TYPES = [
            {
                id: 'boundary',
                name: 'è¾¹ç•Œå€¼è¯„å®¡',
                icon: 'ğŸ“Š',
                desc: 'å…¨é¢çš„è¾¹ç•Œå€¼æµ‹è¯•è¯„å®¡',
                color: 'boundary',
                isDefault: true,
                prompt: `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æµ‹è¯•å·¥ç¨‹å¸ˆ,ä¸“æ³¨äºè¾¹ç•Œå€¼æµ‹è¯•åˆ†æã€‚

**é‡è¦è¯´æ˜:** æµ‹è¯•ç”¨ä¾‹å¯èƒ½ä»¥ XMind æ€ç»´å¯¼å›¾å¤§çº²æ ¼å¼æä¾›,åŒ…å«å±‚çº§ç»“æ„çš„èŠ‚ç‚¹æ ‡é¢˜ã€‚è¯·å°†å±‚çº§å…³ç³»ç†è§£ä¸º:ä¸€çº§èŠ‚ç‚¹=åŠŸèƒ½æ¨¡å—,äºŒçº§èŠ‚ç‚¹=æµ‹è¯•åœºæ™¯,ä¸‰çº§èŠ‚ç‚¹=æµ‹è¯•æ­¥éª¤/é¢„æœŸç»“æœã€‚å³ä½¿æè¿°ç®€ç•¥,ä¹Ÿè¯·åŸºäºç»“æ„å±‚æ¬¡ç»™å‡ºä¸“ä¸šè¯„å®¡ã€‚

è¯·å¯¹ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œè¾¹ç•Œå€¼è¯„å®¡,é‡ç‚¹å…³æ³¨:

1. **è¾¹ç•Œå€¼è¦†ç›–å®Œæ•´æ€§**
   - æ˜¯å¦è¦†ç›–äº†æ‰€æœ‰è¾“å…¥å‚æ•°çš„è¾¹ç•Œå€¼
   - æœ€å°å€¼ã€æœ€å¤§å€¼ã€ä¸´ç•Œå€¼æ˜¯å¦éƒ½æœ‰æµ‹è¯•
   - è¾¹ç•Œå€¼çš„ä¸Šä¸‹æµ®åŠ¨æ˜¯å¦è€ƒè™‘

2. **è¾¹ç•Œæ¡ä»¶è¯†åˆ«**
   - æ•°å€¼å‹è¾¹ç•Œ(æœ€å¤§/æœ€å°/é›¶å€¼)
   - å­—ç¬¦ä¸²è¾¹ç•Œ(ç©ºä¸²/æœ€å¤§é•¿åº¦/ç‰¹æ®Šå­—ç¬¦)
   - é›†åˆè¾¹ç•Œ(ç©ºé›†/å•å…ƒç´ /æ»¡å®¹é‡)
   - æ—¶é—´è¾¹ç•Œ(èµ·å§‹/ç»“æŸ/è·¨è¶Š)

3. **é—æ¼çš„è¾¹ç•Œåœºæ™¯**
   - åˆ—å‡ºå¯èƒ½é—æ¼çš„è¾¹ç•Œæµ‹è¯•ç‚¹
   - ç»™å‡ºè¡¥å……å»ºè®®

æµ‹è¯•ç”¨ä¾‹å†…å®¹:
{content}

è¯·ç”¨æ¸…æ™°çš„ç»“æ„åŒ–æ ¼å¼ç»™å‡ºè¯„å®¡ç»“æœã€‚åŠ¡å¿…æ˜ç¡®æŒ‡å‡ºæµ‹è¯•ç”¨ä¾‹çš„åç§°å’Œå…·ä½“å†…å®¹ã€‚`
            },
            {
                id: 'ambiguity',
                name: 'äºŒä¹‰æ€§æ£€æŸ¥',
                icon: 'ğŸ”',
                desc: 'æ£€æŸ¥ç”¨ä¾‹æè¿°çš„äºŒä¹‰æ€§é—®é¢˜',
                color: 'ambiguity',
                isDefault: true,
                prompt: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æµ‹è¯•ç”¨ä¾‹è¯„å®¡ä¸“å®¶,ä¸“æ³¨äºè¯†åˆ«æµ‹è¯•ç”¨ä¾‹ä¸­çš„äºŒä¹‰æ€§é—®é¢˜ã€‚

**é‡è¦è¯´æ˜:** æµ‹è¯•ç”¨ä¾‹å¯èƒ½ä»¥ XMind æ€ç»´å¯¼å›¾å¤§çº²æ ¼å¼æä¾›,åŒ…å«å±‚çº§ç»“æ„çš„èŠ‚ç‚¹æ ‡é¢˜ã€‚è¯·å°†å±‚çº§å…³ç³»ç†è§£ä¸ºæµ‹è¯•ç”¨ä¾‹çš„ç»„ç»‡ç»“æ„,å³ä½¿æè¿°ç®€ç•¥,ä¹Ÿè¯·åŸºäºä¸Šä¸‹æ–‡ç»™å‡ºä¸“ä¸šè¯„å®¡ã€‚

è¯·å¯¹ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹è¿›è¡ŒäºŒä¹‰æ€§æ£€æŸ¥,é‡ç‚¹å…³æ³¨:

1. **æ¨¡ç³Šè¯æ±‡è¯†åˆ«**
   - "å¤§çº¦"ã€"å·¦å³"ã€"é€‚å½“"ç­‰æ¨¡ç³Šè¡¨è¿°
   - "æ­£å¸¸"ã€"åˆç†"ã€"æœ‰æ•ˆ"ç­‰æœªå®šä¹‰æ ‡å‡†
   - "ç­‰ç­‰"ã€"ç±»ä¼¼"ç­‰ä¸å®Œæ•´æè¿°

2. **æ­§ä¹‰è¡¨è¿°åˆ†æ**
   - å¯èƒ½æœ‰å¤šç§ç†è§£çš„æè¿°
   - ç¼ºå°‘å…·ä½“æ•°å€¼æˆ–æ ‡å‡†çš„åœ°æ–¹
   - ä¸»è§‚åˆ¤æ–­è€Œéå®¢è§‚æ ‡å‡†

3. **æ”¹è¿›å»ºè®®**
   - é’ˆå¯¹æ¯ä¸ªé—®é¢˜ç»™å‡ºå…·ä½“çš„ä¿®æ”¹å»ºè®®
   - æä¾›æ˜ç¡®ã€å¯æµ‹é‡çš„æ›¿ä»£è¡¨è¿°

æµ‹è¯•ç”¨ä¾‹å†…å®¹:
{content}

è¯·åˆ—å‡ºæ‰€æœ‰å‘ç°çš„äºŒä¹‰æ€§é—®é¢˜,å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®ã€‚åŠ¡å¿…æ˜ç¡®æŒ‡å‡ºé—®é¢˜æ‰€åœ¨çš„å…·ä½“æµ‹è¯•ç”¨ä¾‹ã€‚`
            },
            {
                id: 'format',
                name: 'æ ¼å¼è§„èŒƒåŒ–æ£€æŸ¥',
                icon: 'ğŸ“',
                desc: 'æ£€æŸ¥ç”¨ä¾‹æ ¼å¼çš„è§„èŒƒæ€§',
                color: 'format',
                isDefault: true,
                prompt: `ä½ æ˜¯ä¸€ä½æµ‹è¯•ç”¨ä¾‹è§„èŒƒåŒ–ä¸“å®¶,è´Ÿè´£æ£€æŸ¥æµ‹è¯•ç”¨ä¾‹çš„æ ¼å¼è§„èŒƒæ€§ã€‚

**é‡è¦è¯´æ˜:** æµ‹è¯•ç”¨ä¾‹å¯èƒ½ä»¥ XMind æ€ç»´å¯¼å›¾å¤§çº²æ ¼å¼æä¾›,åŒ…å«å±‚çº§ç»“æ„çš„èŠ‚ç‚¹æ ‡é¢˜ã€‚è¯·å°†å±‚çº§å…³ç³»ç†è§£ä¸ºæµ‹è¯•ç”¨ä¾‹çš„ç»„ç»‡æ–¹å¼,åŸºäºè¿™ç§å¤§çº²ç»“æ„è¯„ä¼°å…¶è§„èŒƒæ€§ã€‚

è¯·å¯¹ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæ ¼å¼è§„èŒƒåŒ–æ£€æŸ¥,è¯„ä¼°ä»¥ä¸‹æ–¹é¢:

1. **ç”¨ä¾‹ç»“æ„å®Œæ•´æ€§**
   - ç”¨ä¾‹ç¼–å·/æ ‡è¯†
   - ç”¨ä¾‹æ ‡é¢˜
   - å‰ç½®æ¡ä»¶
   - æµ‹è¯•æ­¥éª¤
   - é¢„æœŸç»“æœ
   - ä¼˜å…ˆçº§/é‡è¦æ€§

2. **æè¿°è§„èŒƒæ€§**
   - æ­¥éª¤æ˜¯å¦æ¸…æ™°ã€å¯æ‰§è¡Œ
   - é¢„æœŸç»“æœæ˜¯å¦æ˜ç¡®ã€å¯éªŒè¯
   - æ˜¯å¦ä½¿ç”¨äº†æ ‡å‡†æœ¯è¯­

3. **æ ¼å¼ä¸€è‡´æ€§**
   - ç¼–å·æ ¼å¼æ˜¯å¦ç»Ÿä¸€
   - æè¿°é£æ ¼æ˜¯å¦ä¸€è‡´
   - å±‚çº§ç»“æ„æ˜¯å¦æ¸…æ™°

4. **æ”¹è¿›å»ºè®®**
   - ç¼ºå¤±çš„å¿…è¦å…ƒç´ 
   - éœ€è¦è§„èŒƒåŒ–çš„å†…å®¹
   - æ ¼å¼ä¼˜åŒ–å»ºè®®

æµ‹è¯•ç”¨ä¾‹å†…å®¹:
{content}

è¯·ç»™å‡ºè¯¦ç»†çš„æ ¼å¼è§„èŒƒåŒ–è¯„å®¡æŠ¥å‘Š,æ˜ç¡®æŒ‡å‡ºå…·ä½“çš„é—®é¢˜æµ‹è¯•ç”¨ä¾‹ã€‚`
            }
        ];

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadReviewTypes();
            loadChatHistory();
            setupDragDrop();
            updateStatus();
            renderQuickReviewButtons();
            
            // åŠ è½½ä¸Šæ¬¡é€‰æ‹©çš„æ¨¡å‹,é»˜è®¤ä½¿ç”¨åƒé—®
            const savedModel = localStorage.getItem('activeModel') || 'qianwen';
            activeModel = savedModel;
            document.getElementById('activeModelSelect').value = savedModel;
        });

        // ==================== é…ç½®ç®¡ç† ====================
        function loadConfig() {
            const config = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
            
            // åŠ è½½ DeepSeek é…ç½®
            if (config.deepseek) {
                document.getElementById('deepseekApiKey').value = config.deepseek.apiKey || '';
                document.getElementById('deepseekModel').value = config.deepseek.model || 'deepseek-chat';
            }
            
            // åŠ è½½åƒé—®é…ç½®
            if (config.qianwen) {
                document.getElementById('qianwenApiUrl').value = config.qianwen.apiUrl || 'http://43.173.153.29:11436/v1/chat/completions';
                document.getElementById('qianwenApiKey').value = config.qianwen.apiKey || '';
                document.getElementById('qianwenModel').value = config.qianwen.model || 'Qwen3-32B-AWQ';
            } else {
                // è®¾ç½®é»˜è®¤å€¼ä¸ºä½ çš„åƒé—® API
                document.getElementById('qianwenApiUrl').value = 'http://43.173.153.29:11436/v1/chat/completions';
                document.getElementById('qianwenModel').value = 'Qwen3-32B-AWQ';
            }
        }

        function saveApiConfig() {
            const deepseekApiKey = document.getElementById('deepseekApiKey').value.trim();
            const deepseekModel = document.getElementById('deepseekModel').value;
            const qianwenApiUrl = document.getElementById('qianwenApiUrl').value.trim();
            const qianwenApiKey = document.getElementById('qianwenApiKey').value.trim();
            const qianwenModel = document.getElementById('qianwenModel').value.trim();

            if (!deepseekApiKey && !qianwenApiKey) {
                showToast('è¯·è‡³å°‘é…ç½®ä¸€ä¸ª API Key', 'error');
                return;
            }

            const config = {
                deepseek: {
                    apiKey: deepseekApiKey,
                    model: deepseekModel
                },
                qianwen: {
                    apiUrl: qianwenApiUrl || 'http://43.173.153.29:11436/v1/chat/completions',
                    apiKey: qianwenApiKey,
                    model: qianwenModel || 'Qwen3-32B-AWQ'
                }
            };

            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            
            showToast('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
            closeModal('apiModal');
            updateStatus();
        }

        function getConfig() {
            return JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
        }

        function updateActiveModel() {
            activeModel = document.getElementById('activeModelSelect').value;
            localStorage.setItem('activeModel', activeModel);
            
            const config = getConfig();
            const modelName = activeModel === 'deepseek' 
                ? (config.deepseek?.model || 'deepseek-chat')
                : (config.qianwen?.model || 'qwen-max');
            
            showToast(`å·²åˆ‡æ¢åˆ° ${activeModel === 'deepseek' ? 'ğŸ”µ DeepSeek' : 'ğŸŸ£ åƒé—®'} (${modelName})`, 'success');
        }

        // ==================== è¯„å®¡ç±»å‹ç®¡ç† ====================
        function loadReviewTypes() {
            let types = JSON.parse(localStorage.getItem(REVIEW_TYPES_KEY) || 'null');
            if (!types) {
                types = DEFAULT_REVIEW_TYPES;
                localStorage.setItem(REVIEW_TYPES_KEY, JSON.stringify(types));
            }
            return types;
        }

        function saveReviewTypes(types) {
            localStorage.setItem(REVIEW_TYPES_KEY, JSON.stringify(types));
            renderQuickReviewButtons();
            renderReviewTypesList();
        }

        function renderQuickReviewButtons() {
            const types = loadReviewTypes();
            const container = document.getElementById('quickReviewButtons');
            
            container.innerHTML = types.map(type => `
                <button class="review-btn ${type.color}" onclick="quickReview('${type.id}')" ${!fileContent ? 'disabled' : ''}>
                    ${type.icon} ${type.name}
                </button>
            `).join('');
        }

        function renderReviewTypesList() {
            const types = loadReviewTypes();
            const container = document.getElementById('reviewTypesList');
            
            container.innerHTML = types.map(type => `
                <div class="review-type-item">
                    <div class="review-type-header">
                        <div class="review-type-name">
                            ${type.icon} ${type.name}
                            ${type.isDefault ? '<span class="default-badge">é»˜è®¤</span>' : ''}
                        </div>
                        <div class="review-type-actions">
                            <button class="btn btn-secondary" onclick="editReviewType('${type.id}')">âœï¸ ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteReviewType('${type.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="review-type-desc">${type.desc}</div>
                </div>
            `).join('');
        }

        function showAddReviewType() {
            editingTypeId = null;
            document.getElementById('editTypeTitle').textContent = 'âœ¨ æ–°å»ºè¯„å®¡ç±»å‹';
            document.getElementById('typeNameInput').value = '';
            document.getElementById('typeIconInput').value = 'ğŸ”§';
            document.getElementById('typeDescInput').value = '';
            document.getElementById('typePromptInput').value = '';
            document.getElementById('typeColorInput').value = 'custom';
            showModal('editTypeModal');
        }

        function editReviewType(id) {
            const types = loadReviewTypes();
            const type = types.find(t => t.id === id);
            if (!type) return;

            editingTypeId = id;
            document.getElementById('editTypeTitle').textContent = 'âœï¸ ç¼–è¾‘è¯„å®¡ç±»å‹';
            document.getElementById('typeNameInput').value = type.name;
            document.getElementById('typeIconInput').value = type.icon;
            document.getElementById('typeDescInput').value = type.desc;
            document.getElementById('typePromptInput').value = type.prompt;
            document.getElementById('typeColorInput').value = type.color;
            showModal('editTypeModal');
        }

        function saveReviewType() {
            const name = document.getElementById('typeNameInput').value.trim();
            const icon = document.getElementById('typeIconInput').value.trim() || 'ğŸ”§';
            const desc = document.getElementById('typeDescInput').value.trim();
            const prompt = document.getElementById('typePromptInput').value.trim();
            const color = document.getElementById('typeColorInput').value;

            if (!name || !prompt) {
                showToast('è¯·å¡«å†™åç§°å’Œ Prompt', 'error');
                return;
            }

            const types = loadReviewTypes();

            if (editingTypeId) {
                const index = types.findIndex(t => t.id === editingTypeId);
                if (index !== -1) {
                    types[index] = { ...types[index], name, icon, desc, prompt, color };
                }
            } else {
                types.push({
                    id: 'custom_' + Date.now(),
                    name,
                    icon,
                    desc,
                    prompt,
                    color,
                    isDefault: false
                });
            }

            saveReviewTypes(types);
            closeModal('editTypeModal');
            showToast('ä¿å­˜æˆåŠŸï¼', 'success');
        }

        function deleteReviewType(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯„å®¡ç±»å‹å—ï¼Ÿ')) return;

            const types = loadReviewTypes();
            const filtered = types.filter(t => t.id !== id);
            saveReviewTypes(filtered);
            showToast('å·²åˆ é™¤', 'success');
        }

        function resetDefaultTypes() {
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è¯„å®¡ç±»å‹å—ï¼Ÿè¿™å°†è¦†ç›–æ‰€æœ‰è‡ªå®šä¹‰ç±»å‹ã€‚')) return;
            
            saveReviewTypes(DEFAULT_REVIEW_TYPES);
            showToast('å·²é‡ç½®ä¸ºé»˜è®¤ç±»å‹', 'success');
        }

        function exportConfig() {
            const types = loadReviewTypes();
            const blob = new Blob([JSON.stringify(types, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'review-types-config.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('é…ç½®å·²å¯¼å‡º', 'success');
        }

        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const types = JSON.parse(text);
                    if (Array.isArray(types)) {
                        saveReviewTypes(types);
                        showToast('é…ç½®å¯¼å…¥æˆåŠŸï¼', 'success');
                    } else {
                        throw new Error('æ— æ•ˆçš„é…ç½®æ ¼å¼');
                    }
                } catch (err) {
                    showToast('å¯¼å…¥å¤±è´¥ï¼š' + err.message, 'error');
                }
            };
            input.click();
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        function setupDragDrop() {
            const zone = document.getElementById('uploadZone');

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            
            if (!['txt', 'xmind', 'xml', 'xlsx', 'xls'].includes(ext)) {
                showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  .txtã€.xmind æˆ– .xlsx/.xls æ–‡ä»¶', 'error');
                return;
            }

            currentFile = file;
            currentFileReviewHistory = []; // é‡ç½®è¯„å®¡å†å²
            
            try {
                if (ext === 'txt' || ext === 'xml') {
                    fileContent = await file.text();
                } else if (ext === 'xmind') {
                    fileContent = await parseXMind(file);
                } else if (ext === 'xlsx' || ext === 'xls') {
                    // Excel æ–‡ä»¶éœ€è¦å…ˆé…ç½®å­—æ®µæ˜ å°„
                    await parseExcel(file);
                    // parseExcel ä¼šå¼¹å‡ºé…ç½®çª—å£ï¼Œç”¨æˆ·ç¡®è®¤åä¼šè®¾ç½® fileContent
                    // è¿™é‡Œç›´æ¥è¿”å›ï¼Œç­‰å¾…ç”¨æˆ·é…ç½®
                    return;
                }

                // éªŒè¯æ–‡ä»¶å†…å®¹
                if (!fileContent || fileContent.trim() === '') {
                    throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }

                console.log('æ–‡ä»¶è§£ææˆåŠŸï¼Œå†…å®¹é•¿åº¦:', fileContent.length);
                console.log('æ–‡ä»¶å†…å®¹é¢„è§ˆ:', fileContent.substring(0, 200));

                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileStatus').textContent = 'âœ“ å·²åŠ è½½';
                document.getElementById('fileContentLength').textContent = `${fileContent.length} ä¸ªå­—ç¬¦`;
                
                // æ˜¾ç¤ºå†…å®¹é¢„è§ˆï¼ˆå‰300ä¸ªå­—ç¬¦ï¼‰
                const preview = fileContent.substring(0, 300);
                document.getElementById('fileContentPreview').textContent = preview + (fileContent.length > 300 ? '\n...' : '');

                // æ›´æ–°çŠ¶æ€æ 
                document.getElementById('fileStatusBar').textContent = `æ–‡ä»¶: ${file.name} (${fileContent.length}å­—ç¬¦)`;

                // å¯ç”¨å¿«é€Ÿè¯„å®¡æŒ‰é’®
                renderQuickReviewButtons();

                showToast(`æ–‡ä»¶åŠ è½½æˆåŠŸï¼è§£æåˆ° ${fileContent.length} ä¸ªå­—ç¬¦`, 'success');
            } catch (err) {
                console.error('æ–‡ä»¶è§£æé”™è¯¯:', err);
                showToast('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message, 'error');
                fileContent = '';
            }
        }

        async function parseXMind(file) {
            try {
                const zip = await JSZip.loadAsync(file);
                console.log('XMind æ–‡ä»¶ç»“æ„:', Object.keys(zip.files));
                
                // å°è¯•è¯»å– content.json (æ–°ç‰ˆ XMind)
                let contentFile = zip.file('content.json');
                if (contentFile) {
                    console.log('æ‰¾åˆ° content.json');
                    const content = await contentFile.async('string');
                    const data = JSON.parse(content);
                    const result = extractXMindContent(data);
                    console.log('content.json è§£æç»“æœé•¿åº¦:', result.length);
                    return result;
                }

                // å°è¯•è¯»å– content.xml (æ—§ç‰ˆ XMind)
                contentFile = zip.file('content.xml');
                if (contentFile) {
                    console.log('æ‰¾åˆ° content.xml');
                    const content = await contentFile.async('string');
                    const result = parseXMindXML(content);
                    console.log('content.xml è§£æç»“æœé•¿åº¦:', result.length);
                    return result;
                }

                throw new Error('æ— æ³•æ‰¾åˆ° XMind å†…å®¹æ–‡ä»¶ (content.json æˆ– content.xml)');
            } catch (err) {
                console.error('XMind è§£æé”™è¯¯:', err);
                throw new Error('XMind è§£æå¤±è´¥ï¼š' + err.message);
            }
        }

        function extractXMindContent(data, level = 0) {
            let result = '';
            
            if (Array.isArray(data)) {
                for (const item of data) {
                    result += extractXMindContent(item, level);
                }
            } else if (typeof data === 'object' && data !== null) {
                if (data.title) {
                    const indent = '  '.repeat(level);
                    let line = '';
                    
                    // æ ¹æ®å±‚çº§æ·»åŠ ä¸åŒæ ¼å¼
                    if (level === 0) {
                        line = `\nã€æ¨¡å—ã€‘${data.title}\n` + 'â”€'.repeat(40) + '\n';
                    } else if (level === 1) {
                        line = `\n${indent}â–¶ ${data.title}\n`;
                    } else {
                        line = `${indent}  â€¢ ${data.title}\n`;
                    }
                    
                    // æå–å¤‡æ³¨
                    if (data.notes && data.notes.plain) {
                        const noteText = data.notes.plain.content || data.notes.plain;
                        if (noteText && noteText.trim()) {
                            line += `${indent}     ğŸ“ ${noteText.trim()}\n`;
                        }
                    }
                    
                    // æå–æ ‡ç­¾
                    if (data.labels && Array.isArray(data.labels)) {
                        const labelTexts = data.labels.join(', ');
                        line += `${indent}     ğŸ·ï¸ ${labelTexts}\n`;
                    }
                    
                    result += line;
                }
                
                if (data.rootTopic) {
                    result += extractXMindContent(data.rootTopic, level);
                }
                
                if (data.children) {
                    if (data.children.attached) {
                        for (const child of data.children.attached) {
                            result += extractXMindContent(child, level + 1);
                        }
                    }
                }
            }
            
            return result;
        }

        function parseXMindXML(xmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlString, 'text/xml');
            
            // æ£€æŸ¥è§£æé”™è¯¯
            const parserError = doc.querySelector('parsererror');
            if (parserError) {
                console.error('[XMind] XMLè§£æé”™è¯¯:', parserError.textContent);
                throw new Error('XML æ ¼å¼é”™è¯¯');
            }
            
            let result = '';
            let moduleCount = 0;
            const topics = doc.querySelectorAll('topic');
            
            console.log('[XMind] æ‰¾åˆ° topic èŠ‚ç‚¹æ•°é‡:', topics.length);
            
            topics.forEach((topic, index) => {
                const title = topic.querySelector(':scope > title');
                if (!title) return;
                
                const depth = getTopicDepth(topic);
                const titleText = title.textContent.trim();
                const indent = '  '.repeat(depth);
                
                // æ ¹æ®å±‚çº§æ·»åŠ ä¸åŒçš„æ ¼å¼
                if (depth === 0) {
                    moduleCount++;
                    result += `\nã€æ¨¡å— ${moduleCount}ã€‘${titleText}\n`;
                    result += 'â”€'.repeat(40) + '\n';
                } else if (depth === 1) {
                    result += `\n${indent}â–¶ ${titleText}\n`;
                } else {
                    result += `${indent}  â€¢ ${titleText}\n`;
                }
                
                // æå–å¤‡æ³¨ä¿¡æ¯
                const notes = topic.querySelector(':scope > notes');
                if (notes) {
                    const plainNotes = notes.querySelector('plain');
                    if (plainNotes) {
                        const noteText = plainNotes.textContent.trim();
                        if (noteText) {
                            result += `${indent}     ğŸ“ ${noteText}\n`;
                        }
                    }
                }
                
                // æå–æ ‡ç­¾
                const labels = topic.querySelectorAll(':scope > labels > label');
                if (labels.length > 0) {
                    const labelTexts = Array.from(labels).map(l => l.textContent.trim()).join(', ');
                    result += `${indent}     ğŸ·ï¸ ${labelTexts}\n`;
                }
            });
            
            if (!result) {
                console.warn('[XMind] æœªèƒ½ä» XML æå–å†…å®¹,è¿”å›åŸå§‹æ–‡æœ¬');
                return xmlString;
            }
            
            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            result += '\n' + 'â”€'.repeat(40) + '\n';
            result += `[ç»Ÿè®¡] å…± ${topics.length} ä¸ªæµ‹è¯•èŠ‚ç‚¹\n`;
            
            console.log('[XMind] XMLè§£æå®Œæˆ,æå–äº†', result.length, 'ä¸ªå­—ç¬¦');
            console.log('[XMind] è§£æç»“æœé¢„è§ˆ:', result.substring(0, 200));
            
            return result;
        }

        function getTopicDepth(element) {
            let depth = 0;
            let parent = element.parentElement;
            while (parent) {
                if (parent.tagName === 'topic') depth++;
                parent = parent.parentElement;
            }
            return depth;
        }

        // ==================== Excel è§£æ ====================
        async function parseExcel(file) {
            try {
                console.log('[Excel] å¼€å§‹è§£æ Excel æ–‡ä»¶:', file.name);
                
                // è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                
                // ä½¿ç”¨ SheetJS è§£æ
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                console.log('[Excel] å·¥ä½œç°¿ä¿¡æ¯:', {
                    sheetNames: workbook.SheetNames,
                    sheetCount: workbook.SheetNames.length
                });
                
                // åªå¤„ç†ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½¬æ¢ä¸º JSON æ ¼å¼ (ä¿ç•™ç©ºå•å…ƒæ ¼)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,  // ä½¿ç”¨æ•°ç»„æ ¼å¼
                    defval: ''  // ç©ºå•å…ƒæ ¼é»˜è®¤å€¼
                });
                
                if (jsonData.length === 0) {
                    throw new Error('Excel æ–‡ä»¶ä¸ºç©º');
                }
                
                console.log(`[Excel] å·¥ä½œè¡¨ "${firstSheetName}" æœ‰ ${jsonData.length} è¡Œ`);
                
                // æ™ºèƒ½è¯†åˆ«è¡¨å¤´
                const headerInfo = identifyHeaders(jsonData);
                
                if (headerInfo.rowIndex === -1) {
                    throw new Error('æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆçš„è¡¨å¤´è¡Œï¼Œè¯·ç¡®ä¿ Excel æ–‡ä»¶åŒ…å«æ ‡å‡†çš„ç”¨ä¾‹è¡¨å¤´');
                }
                
                const headers = jsonData[headerInfo.rowIndex];
                const dataRows = jsonData.slice(headerInfo.rowIndex + 1);
                
                // è¿‡æ»¤æ‰å®Œå…¨ç©ºçš„è¡Œ
                const validRows = dataRows.filter(row => {
                    return row.some(cell => cell && cell.toString().trim() !== '');
                });
                
                console.log(`[Excel] è¯†åˆ«åˆ°è¡¨å¤´ (ç¬¬${headerInfo.rowIndex + 1}è¡Œ):`, headers);
                console.log(`[Excel] æœ‰æ•ˆæ•°æ®è¡Œ: ${validRows.length}`);
                
                // ä¿å­˜åŸå§‹æ•°æ®
                excelRawData = {
                    fileName: file.name,
                    headers: headers,
                    rows: validRows
                };
                
                // å¼¹å‡ºå­—æ®µæ˜ å°„é…ç½®çª—å£
                showExcelMappingModal();
                
                // è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œç­‰å¾…ç”¨æˆ·é…ç½®æ˜ å°„åå†ç”Ÿæˆå†…å®¹
                return '';
                
            } catch (err) {
                console.error('[Excel] è§£æé”™è¯¯:', err);
                throw new Error('Excel è§£æå¤±è´¥ï¼š' + err.message);
            }
        }

        // æ™ºèƒ½è¯†åˆ«è¡¨å¤´
        function identifyHeaders(jsonData) {
            if (jsonData.length === 0) return { rowIndex: -1, headers: [] };
            
            // å¸¸è§çš„æµ‹è¯•ç”¨ä¾‹è¡¨å¤´å…³é”®è¯
            const headerKeywords = [
                'ç”¨ä¾‹ç¼–å·', 'ç”¨ä¾‹ID', 'ID', 'ç¼–å·', 'Case ID', 'Test Case ID',
                'ç”¨ä¾‹åç§°', 'ç”¨ä¾‹æ ‡é¢˜', 'æµ‹è¯•ç‚¹', 'åŠŸèƒ½ç‚¹', 'Title', 'Name', 'Case Name',
                'å‰ç½®æ¡ä»¶', 'å‰ææ¡ä»¶', 'Precondition', 'Pre-condition',
                'æµ‹è¯•æ­¥éª¤', 'æ“ä½œæ­¥éª¤', 'Steps', 'Test Steps',
                'é¢„æœŸç»“æœ', 'æœŸæœ›ç»“æœ', 'Expected Result', 'Expected',
                'ä¼˜å…ˆçº§', 'Priority', 'Level',
                'æµ‹è¯•ç±»å‹', 'Type', 'Category',
                'å¤‡æ³¨', 'è¯´æ˜', 'Remark', 'Note', 'Description'
            ];
            
            // æ£€æŸ¥å‰5è¡Œ
            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                const row = jsonData[i];
                let matchCount = 0;
                
                for (const cell of row) {
                    if (!cell) continue;
                    const cellStr = cell.toString().trim();
                    
                    for (const keyword of headerKeywords) {
                        if (cellStr.includes(keyword) || keyword.includes(cellStr)) {
                            matchCount++;
                            break;
                        }
                    }
                }
                
                // å¦‚æœæœ‰3ä¸ªä»¥ä¸ŠåŒ¹é…ï¼Œè®¤ä¸ºæ˜¯è¡¨å¤´
                if (matchCount >= 3) {
                    console.log(`[Excel] åœ¨ç¬¬${i + 1}è¡Œæ‰¾åˆ°è¡¨å¤´ï¼ŒåŒ¹é…åº¦: ${matchCount}`);
                    return { rowIndex: i, headers: row };
                }
                
                // æˆ–è€…éç©ºå•å…ƒæ ¼è¶…è¿‡ä¸€åŠéƒ½æ˜¯æ–‡å­—ä¸”è¾ƒçŸ­ï¼ˆå¯èƒ½æ˜¯è¡¨å¤´ï¼‰
                const nonEmptyCells = row.filter(c => c && c.toString().trim());
                if (nonEmptyCells.length >= 3) {
                    const shortTextCount = nonEmptyCells.filter(c => {
                        const str = c.toString();
                        return str.length > 0 && str.length < 20 && /[\u4e00-\u9fa5a-zA-Z]/.test(str);
                    }).length;
                    
                    if (shortTextCount >= nonEmptyCells.length * 0.6) {
                        console.log(`[Excel] åœ¨ç¬¬${i + 1}è¡Œå¯èƒ½æ˜¯è¡¨å¤´ (æ–‡æœ¬ç‰¹å¾)`);
                        return { rowIndex: i, headers: row };
                    }
                }
            }
            
            return { rowIndex: -1, headers: [] };
        }

        // æ ¼å¼åŒ–æµ‹è¯•ç”¨ä¾‹è¡Œ
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ==================== Excel å­—æ®µæ˜ å°„é…ç½® ====================
        function showExcelMappingModal() {
            if (!excelRawData) return;
            
            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
            document.getElementById('excelFileName').textContent = excelRawData.fileName;
            document.getElementById('excelHeaderCount').textContent = `${excelRawData.headers.length} åˆ—`;
            
            // ç”Ÿæˆå­—æ®µæ˜ å°„é€‰æ‹©å™¨
            const container = document.getElementById('fieldMappingContainer');
            
            // å®šä¹‰ç”¨ä¾‹å­—æ®µï¼ˆé¡ºåºå’Œé‡è¦æ€§ï¼‰
            const caseFields = [
                { id: 'precondition', name: 'å‰ç½®æ¡ä»¶', icon: 'âš™ï¸', required: true, keywords: ['å‰ç½®æ¡ä»¶', 'å‰ææ¡ä»¶', 'Precondition', 'Pre-condition', 'å‰ç½®'] },
                { id: 'steps', name: 'æ“ä½œæ­¥éª¤', icon: 'ğŸ“', required: true, keywords: ['æµ‹è¯•æ­¥éª¤', 'æ“ä½œæ­¥éª¤', 'Steps', 'Test Steps', 'æ­¥éª¤'] },
                { id: 'expected', name: 'é¢„æœŸç»“æœ', icon: 'âœ…', required: true, keywords: ['é¢„æœŸç»“æœ', 'æœŸæœ›ç»“æœ', 'Expected Result', 'Expected', 'é¢„æœŸ', 'ç»“æœ'] },
                { id: 'module', name: 'åŠŸèƒ½æ¨¡å—', icon: 'ğŸ“¦', required: false, keywords: ['åŠŸèƒ½æ¨¡å—', 'æ¨¡å—', 'Module', 'åŠŸèƒ½'] },
                { id: 'submodule', name: 'å­æ¨¡å—', icon: 'ğŸ“', required: false, keywords: ['å­æ¨¡å—', 'Sub Module', 'å­åŠŸèƒ½'] },
                { id: 'description', name: 'ç”¨ä¾‹æè¿°', icon: 'ğŸ“‹', required: false, keywords: ['ç”¨ä¾‹æè¿°', 'ç”¨ä¾‹åç§°', 'ç”¨ä¾‹æ ‡é¢˜', 'æè¿°', 'Description', 'Title', 'Name'] },
                { id: 'caseid', name: 'ç”¨ä¾‹ç¼–å·', icon: 'ğŸ”–', required: false, keywords: ['ç”¨ä¾‹ç¼–å·', 'ç”¨ä¾‹ID', 'Case ID', 'ID', 'ç¼–å·'] },
                { id: 'priority', name: 'ä¼˜å…ˆçº§', icon: 'â­', required: false, keywords: ['ä¼˜å…ˆçº§', 'Priority', 'Level'] }
            ];
            
            container.innerHTML = caseFields.map(field => {
                // æ™ºèƒ½åŒ¹é…é»˜è®¤å€¼
                const matchedIndex = autoMatchField(field.keywords, excelRawData.headers);
                
                return `
                    <div style="background: white; padding: 16px; border-radius: 10px; border: 2px solid ${field.required ? '#F59E0B' : '#E5E7EB'};">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 20px;">${field.icon}</span>
                            <strong style="color: ${field.required ? '#D97706' : '#1F2937'}; font-size: 14px;">
                                ${field.name}
                                ${field.required ? '<span style="color: #EF4444; margin-left: 4px;">*</span>' : ''}
                            </strong>
                        </div>
                        <select class="form-select field-mapping-select" data-field-id="${field.id}" data-required="${field.required}" style="font-size: 13px;">
                            <option value="">ä¸æ˜ å°„</option>
                            ${excelRawData.headers.map((header, index) => `
                                <option value="${index}" ${matchedIndex === index ? 'selected' : ''}>
                                    ${header || '(ç©ºåˆ—' + (index + 1) + ')'}
                                </option>
                            `).join('')}
                        </select>
                        ${field.required ? '<div style="font-size: 11px; color: #DC2626; margin-top: 6px;">å¿…é€‰å­—æ®µ</div>' : ''}
                    </div>
                `;
            }).join('');
            
            showModal('excelMappingModal');
        }
        
        // æ™ºèƒ½åŒ¹é…å­—æ®µ
        function autoMatchField(keywords, headers) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().trim();
                for (const keyword of keywords) {
                    if (header.includes(keyword) || keyword.includes(header)) {
                        return i;
                    }
                }
            }
            return -1;
        }
        
        // ç¡®è®¤å­—æ®µæ˜ å°„å¹¶ç”Ÿæˆå†…å®¹
        function confirmExcelMapping() {
            const selects = document.querySelectorAll('.field-mapping-select');
            const mapping = {};
            
            // éªŒè¯å¿…é€‰å­—æ®µ
            const requiredFields = ['precondition', 'steps', 'expected'];
            for (const fieldId of requiredFields) {
                const select = document.querySelector(`[data-field-id="${fieldId}"]`);
                const value = select.value;
                if (!value || value === '') {
                    showToast(`è¯·é€‰æ‹©å¿…é€‰å­—æ®µï¼š${select.closest('div').querySelector('strong').textContent.replace('*', '').trim()}`, 'error');
                    return;
                }
                mapping[fieldId] = parseInt(value);
            }
            
            // æ”¶é›†å…¶ä»–å­—æ®µ
            selects.forEach(select => {
                const fieldId = select.dataset.fieldId;
                const value = select.value;
                if (value && value !== '' && !requiredFields.includes(fieldId)) {
                    mapping[fieldId] = parseInt(value);
                }
            });
            
            console.log('[Excel] å­—æ®µæ˜ å°„:', mapping);
            excelFieldMapping = mapping;
            
            // ç”Ÿæˆæ ¼å¼åŒ–å†…å®¹
            const formattedContent = generateExcelContent();
            
            if (!formattedContent) {
                showToast('ç”Ÿæˆå†…å®¹å¤±è´¥', 'error');
                return;
            }
            
            fileContent = formattedContent;
            
            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = excelRawData.fileName;
            document.getElementById('fileSize').textContent = formatFileSize(currentFile.size);
            document.getElementById('fileStatus').textContent = 'âœ“ å·²åŠ è½½å¹¶é…ç½®';
            document.getElementById('fileContentLength').textContent = `${fileContent.length} ä¸ªå­—ç¬¦`;
            
            const preview = fileContent.substring(0, 300);
            document.getElementById('fileContentPreview').textContent = preview + (fileContent.length > 300 ? '\n...' : '');
            
            document.getElementById('fileStatusBar').textContent = `æ–‡ä»¶: ${excelRawData.fileName} (${fileContent.length}å­—ç¬¦)`;
            
            // å¯ç”¨å¿«é€Ÿè¯„å®¡æŒ‰é’®
            renderQuickReviewButtons();
            
            closeModal('excelMappingModal');
            showToast(`Excel è§£ææˆåŠŸï¼å…± ${excelRawData.rows.length} æ¡ç”¨ä¾‹`, 'success');
        }
        
        // ç”Ÿæˆæ ¼å¼åŒ–çš„ Excel å†…å®¹
        function generateExcelContent() {
            if (!excelRawData || !excelFieldMapping) return '';
            
            const { headers, rows } = excelRawData;
            const mapping = excelFieldMapping;
            
            let result = `\n${'â•'.repeat(60)}\n`;
            result += `ğŸ“Š Excel æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£\n`;
            result += `${'â•'.repeat(60)}\n\n`;
            result += `ğŸ“„ æ–‡ä»¶: ${excelRawData.fileName}\n`;
            result += `ğŸ“‹ ç”¨ä¾‹æ€»æ•°: ${rows.length}\n\n`;
            
            // å­—æ®µæ˜ å°„è¯´æ˜
            result += `ğŸ”— å­—æ®µæ˜ å°„:\n`;
            const fieldNames = {
                precondition: 'å‰ç½®æ¡ä»¶',
                steps: 'æ“ä½œæ­¥éª¤',
                expected: 'é¢„æœŸç»“æœ',
                module: 'åŠŸèƒ½æ¨¡å—',
                submodule: 'å­æ¨¡å—',
                description: 'ç”¨ä¾‹æè¿°',
                caseid: 'ç”¨ä¾‹ç¼–å·',
                priority: 'ä¼˜å…ˆçº§'
            };
            
            for (const [fieldId, colIndex] of Object.entries(mapping)) {
                result += `  â€¢ ${fieldNames[fieldId]} â† ${headers[colIndex]}\n`;
            }
            
            result += `\n${'-'.repeat(60)}\n\n`;
            
            // éå†æ•°æ®è¡Œ
            rows.forEach((row, index) => {
                result += `ã€ç”¨ä¾‹ ${index + 1}ã€‘\n`;
                
                // æŒ‰å­—æ®µé¡ºåºè¾“å‡º
                const orderedFields = ['caseid', 'module', 'submodule', 'description', 'precondition', 'steps', 'expected', 'priority'];
                
                orderedFields.forEach(fieldId => {
                    if (mapping.hasOwnProperty(fieldId)) {
                        const colIndex = mapping[fieldId];
                        const value = row[colIndex] || '(æ— )';
                        const icon = getFieldIcon(fieldId);
                        result += `  ${icon} ${fieldNames[fieldId]}: ${value}\n`;
                    }
                });
                
                result += '\n';
            });
            
            console.log('[Excel] ç”Ÿæˆå†…å®¹é•¿åº¦:', result.length);
            return result;
        }
        
        // è·å–å­—æ®µå›¾æ ‡
        function getFieldIcon(fieldId) {
            const icons = {
                caseid: 'ğŸ”–',
                module: 'ğŸ“¦',
                submodule: 'ğŸ“',
                description: 'ğŸ“‹',
                precondition: 'âš™ï¸',
                steps: 'ğŸ“',
                expected: 'âœ…',
                priority: 'â­'
            };
            return icons[fieldId] || 'â€¢';
        }
        
        // ä¸‹è½½ Excel æ¨¡æ¿
        function downloadExcelTemplate() {
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // å®šä¹‰æ¨¡æ¿æ•°æ®
            const templateData = [
                ['ç”¨ä¾‹ç¼–å·', 'åŠŸèƒ½æ¨¡å—', 'å­æ¨¡å—', 'ç”¨ä¾‹æè¿°', 'å‰ç½®æ¡ä»¶', 'æ“ä½œæ­¥éª¤', 'é¢„æœŸç»“æœ', 'ä¼˜å…ˆçº§'],
                ['TC001', 'ç™»å½•æ¨¡å—', 'è´¦å·å¯†ç ç™»å½•', 'æ­£å¸¸ç™»å½•æµ‹è¯•', 'ç”¨æˆ·å·²æ³¨å†Œä¸”è´¦å·çŠ¶æ€æ­£å¸¸', '1. æ‰“å¼€ç™»å½•é¡µé¢\n2. è¾“å…¥æ­£ç¡®çš„è´¦å·å’Œå¯†ç \n3. ç‚¹å‡»ç™»å½•æŒ‰é’®', 'æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°é¦–é¡µ', 'é«˜'],
                ['TC002', 'ç™»å½•æ¨¡å—', 'è´¦å·å¯†ç ç™»å½•', 'è´¦å·ä¸ºç©º', 'æ— ', '1. æ‰“å¼€ç™»å½•é¡µé¢\n2. å¯†ç è¾“å…¥æ¡†è¾“å…¥å¯†ç \n3. è´¦å·è¾“å…¥æ¡†ä¿æŒä¸ºç©º\n4. ç‚¹å‡»ç™»å½•æŒ‰é’®', 'æç¤º"è¯·è¾“å…¥è´¦å·"', 'é«˜'],
                ['TC003', 'ç™»å½•æ¨¡å—', 'è´¦å·å¯†ç ç™»å½•', 'å¯†ç ä¸ºç©º', 'æ— ', '1. æ‰“å¼€ç™»å½•é¡µé¢\n2. è´¦å·è¾“å…¥æ¡†è¾“å…¥è´¦å·\n3. å¯†ç è¾“å…¥æ¡†ä¿æŒä¸ºç©º\n4. ç‚¹å‡»ç™»å½•æŒ‰é’®', 'æç¤º"è¯·è¾“å…¥å¯†ç "', 'é«˜'],
                ['TC004', 'ç™»å½•æ¨¡å—', 'è´¦å·å¯†ç ç™»å½•', 'å¯†ç é”™è¯¯', 'ç”¨æˆ·å·²æ³¨å†Œ', '1. æ‰“å¼€ç™»å½•é¡µé¢\n2. è¾“å…¥æ­£ç¡®çš„è´¦å·\n3. è¾“å…¥é”™è¯¯çš„å¯†ç \n4. ç‚¹å‡»ç™»å½•æŒ‰é’®', 'æç¤º"è´¦å·æˆ–å¯†ç é”™è¯¯"', 'ä¸­'],
                ['TC005', 'ç™»å½•æ¨¡å—', 'è´¦å·å¯†ç ç™»å½•', 'è´¦å·ä¸å­˜åœ¨', 'æ— ', '1. æ‰“å¼€ç™»å½•é¡µé¢\n2. è¾“å…¥æœªæ³¨å†Œçš„è´¦å·\n3. è¾“å…¥ä»»æ„å¯†ç \n4. ç‚¹å‡»ç™»å½•æŒ‰é’®', 'æç¤º"è´¦å·ä¸å­˜åœ¨"', 'ä¸­']
            ];
            
            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 12 },  // ç”¨ä¾‹ç¼–å·
                { wch: 12 },  // åŠŸèƒ½æ¨¡å—
                { wch: 15 },  // å­æ¨¡å—
                { wch: 18 },  // ç”¨ä¾‹æè¿°
                { wch: 20 },  // å‰ç½®æ¡ä»¶
                { wch: 40 },  // æ“ä½œæ­¥éª¤
                { wch: 30 },  // é¢„æœŸç»“æœ
                { wch: 10 }   // ä¼˜å…ˆçº§
            ];
            
            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'æµ‹è¯•ç”¨ä¾‹');
            
            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, 'æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿.xlsx');
            
            showToast('Excel æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼', 'success');
        }

        // ==================== èŠå¤©åŠŸèƒ½ ====================
        function loadChatHistory() {
            chatHistory = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
        }

        function saveChatHistory() {
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
        }

        function addMessage(role, content) {
            chatHistory.push({ role, content, timestamp: new Date().toISOString() });
            saveChatHistory();
            renderMessage(role, content);
        }

        function renderMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-ai';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const config = getConfig();
            const currentConfig = activeModel === 'deepseek' ? config.deepseek : config.qianwen;
            
            if (!currentConfig?.apiKey) {
                showToast(`è¯·å…ˆé…ç½® ${activeModel === 'deepseek' ? 'DeepSeek' : 'åƒé—®'} API Key`, 'error');
                showModal('apiModal');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // æ„å»ºä¸Šä¸‹æ–‡
            let contextMessage = message;
            if (fileContent && !chatHistory.some(m => m.content.includes('æµ‹è¯•ç”¨ä¾‹å†…å®¹ï¼š'))) {
                contextMessage = `å½“å‰å·²ä¸Šä¼ çš„æµ‹è¯•ç”¨ä¾‹å†…å®¹ï¼š\n${fileContent}\n\nç”¨æˆ·é—®é¢˜ï¼š${message}`;
            }

            await callAI(contextMessage);
        }

        async function quickReview(typeId) {
            if (!fileContent) {
                showToast('è¯·å…ˆä¸Šä¼ æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å†…å®¹
            if (!fileContent.trim()) {
                showToast('æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            const config = getConfig();
            const currentConfig = activeModel === 'deepseek' ? config.deepseek : config.qianwen;
            
            if (!currentConfig?.apiKey) {
                showToast(`è¯·å…ˆé…ç½® ${activeModel === 'deepseek' ? 'DeepSeek' : 'åƒé—®'} API Key`, 'error');
                showModal('apiModal');
                return;
            }

            const types = loadReviewTypes();
            const type = types.find(t => t.id === typeId);
            if (!type) return;

            // è®°å½•è¯„å®¡å†å²
            currentFileReviewHistory.push({
                typeId: typeId,
                typeName: type.name,
                timestamp: new Date().toISOString()
            });
            console.log('[å¿«é€Ÿè¯„å®¡] å½“å‰æ–‡ä»¶è¯„å®¡å†å²:', currentFileReviewHistory);

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', `è¯·è¿›è¡Œã€Œ${type.name}ã€è¯„å®¡`);

            // åŒ…è£…æ–‡ä»¶å†…å®¹ - æ ¹æ®æ–‡ä»¶ç±»å‹æ·»åŠ æ ¼å¼è¯´æ˜
            let wrappedContent = fileContent;
            let testCaseCount = 0; // ç”¨ä¾‹æ•°é‡ç»Ÿè®¡
            
            if (currentFile && currentFile.name.endsWith('.xmind')) {
                // XMind æ–‡ä»¶åŒ…è£…
                wrappedContent = `# ğŸ“‹ æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£è¯´æ˜

**æ–‡ä»¶æ¥æº:** XMind æ€ç»´å¯¼å›¾ (${currentFile.name})
**æ–‡ä»¶æ ¼å¼:** å±‚çº§ç»“æ„å¤§çº²
**è§£ææ–¹å¼:** è‡ªåŠ¨æå–èŠ‚ç‚¹æ ‡é¢˜ã€å¤‡æ³¨ã€æ ‡ç­¾ä¿¡æ¯
**å†…å®¹ç±»å‹:** æµ‹è¯•ç”¨ä¾‹ç»“æ„åŒ–æè¿°

âš ï¸ **é‡è¦æç¤º:**
è¿™æ˜¯ä¸€ä¸ªçœŸå®çš„æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£,è™½ç„¶ä»¥å¤§çº²å½¢å¼å‘ˆç°,ä½†åŒ…å«äº†å®Œæ•´çš„æµ‹è¯•åœºæ™¯å±‚çº§ç»“æ„ã€‚
è¯·å°†æ¯ä¸ªèŠ‚ç‚¹è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æµ‹è¯•ç‚¹,æ ¹æ®å±‚çº§å…³ç³»ç†è§£æµ‹è¯•ç”¨ä¾‹çš„ç»„ç»‡æ–¹å¼ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“„ æµ‹è¯•ç”¨ä¾‹å†…å®¹å¼€å§‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${fileContent}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“„ æµ‹è¯•ç”¨ä¾‹å†…å®¹ç»“æŸ (å…± ${fileContent.split('\n').filter(l => l.trim()).length} ä¸ªæœ‰æ•ˆèŠ‚ç‚¹)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ **è¯„å®¡è¦æ±‚:**
1. è¯·å°†æ¯ä¸ªä¸€çº§èŠ‚ç‚¹è§†ä¸ºåŠŸèƒ½æ¨¡å—
2. å°†æ¯ä¸ªäºŒçº§èŠ‚ç‚¹è§†ä¸ºæµ‹è¯•åœºæ™¯
3. å°†æ¯ä¸ªä¸‰çº§åŠä»¥ä¸‹èŠ‚ç‚¹è§†ä¸ºå…·ä½“çš„æµ‹è¯•æ­¥éª¤æˆ–é¢„æœŸç»“æœ
4. åŸºäºè¿™ä¸ªç»“æ„å±‚æ¬¡,åˆ†ææµ‹è¯•è¦†ç›–æƒ…å†µ
5. æŒ‡å‡ºé—æ¼çš„è¾¹ç•Œæƒ…å†µã€å¼‚å¸¸åœºæ™¯å’Œè¡¥å……å»ºè®®
6. å³ä½¿æŸäº›èŠ‚ç‚¹æè¿°ç®€ç•¥,ä¹Ÿè¯·åŸºäºä¸Šä¸‹æ–‡ç»™å‡ºä¸“ä¸šåˆ¤æ–­

è¯·å¼€å§‹æ‚¨çš„ä¸“ä¸šè¯„å®¡:`;
            } else if (currentFile && (currentFile.name.endsWith('.xlsx') || currentFile.name.endsWith('.xls'))) {
                // Excel æ–‡ä»¶åŒ…è£…
                testCaseCount = (fileContent.match(/ã€ç”¨ä¾‹ \d+ã€‘/g) || []).length;
                wrappedContent = `# ğŸ“‹ æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£è¯´æ˜

**æ–‡ä»¶æ¥æº:** Excel è¡¨æ ¼ (${currentFile.name})
**æ–‡ä»¶æ ¼å¼:** ç»“æ„åŒ–è¡¨æ ¼
**è§£ææ–¹å¼:** è‡ªåŠ¨è¯†åˆ«è¡¨å¤´å’Œå­—æ®µ
**å†…å®¹ç±»å‹:** æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼æ•°æ®

âš ï¸ **é‡è¦æç¤º:**
è¿™æ˜¯ä¸€ä¸ªçœŸå®çš„æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£,ä»¥è¡¨æ ¼å½¢å¼ç»„ç»‡ã€‚æ¯ä¸ªã€ç”¨ä¾‹ã€‘ä»£è¡¨ä¸€æ¡å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹,
åŒ…å«ç”¨ä¾‹ç¼–å·ã€åç§°ã€å‰ç½®æ¡ä»¶ã€æµ‹è¯•æ­¥éª¤ã€é¢„æœŸç»“æœç­‰æ ‡å‡†å­—æ®µã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“„ æµ‹è¯•ç”¨ä¾‹å†…å®¹å¼€å§‹ (å…± ${testCaseCount} æ¡ç”¨ä¾‹)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${fileContent}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“„ æµ‹è¯•ç”¨ä¾‹å†…å®¹ç»“æŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ **è¯„å®¡è¦æ±‚:**
1. åˆ†ææ¯æ¡æµ‹è¯•ç”¨ä¾‹çš„å®Œæ•´æ€§å’Œè§„èŒƒæ€§
2. æ£€æŸ¥æµ‹è¯•æ­¥éª¤çš„æ¸…æ™°åº¦å’Œå¯æ‰§è¡Œæ€§
3. éªŒè¯é¢„æœŸç»“æœçš„æ˜ç¡®æ€§å’Œå¯éªŒè¯æ€§
4. è¯„ä¼°æµ‹è¯•è¦†ç›–çš„å®Œæ•´æ€§
5. è¯†åˆ«é—æ¼çš„è¾¹ç•Œæƒ…å†µã€å¼‚å¸¸åœºæ™¯å’Œç‰¹æ®Šæƒ…å†µ
6. ç»™å‡ºå…·ä½“çš„æ”¹è¿›å»ºè®®

è¯·å¼€å§‹æ‚¨çš„ä¸“ä¸šè¯„å®¡:`;
            }

            // æ„å»º prompt - ç¡®ä¿æ–‡ä»¶å†…å®¹æ­£ç¡®æ›¿æ¢
            let prompt;
            if (type.prompt.includes('{content}')) {
                // å¦‚æœæ¨¡æ¿åŒ…å« {content} å ä½ç¬¦,è¿›è¡Œæ›¿æ¢
                prompt = type.prompt.replace('{content}', wrappedContent);
                console.log('[å¿«é€Ÿè¯„å®¡] âœ“ ä½¿ç”¨ {content} å ä½ç¬¦æ›¿æ¢');
            } else {
                // å¦‚æœæ¨¡æ¿ä¸åŒ…å« {content},åˆ™è¿½åŠ æµ‹è¯•ç”¨ä¾‹å†…å®¹åˆ°æœ«å°¾
                prompt = type.prompt + '\n\n' + wrappedContent;
                console.log('[å¿«é€Ÿè¯„å®¡] âš ï¸ æ¨¡æ¿ä¸­æœªæ‰¾åˆ° {content} å ä½ç¬¦,è‡ªåŠ¨è¿½åŠ å†…å®¹åˆ°æœ«å°¾');
            }
            
            console.log('[å¿«é€Ÿè¯„å®¡] ç±»å‹:', type.name);
            console.log('[å¿«é€Ÿè¯„å®¡] æ–‡ä»¶:', currentFile ? currentFile.name : 'æœªçŸ¥');
            console.log('[å¿«é€Ÿè¯„å®¡] åŸå§‹å†…å®¹é•¿åº¦:', fileContent.length);
            console.log('[å¿«é€Ÿè¯„å®¡] åŒ…è£…åå†…å®¹é•¿åº¦:', wrappedContent.length);
            console.log('[å¿«é€Ÿè¯„å®¡] æœ€ç»ˆPrompté•¿åº¦:', prompt.length);
            console.log('[å¿«é€Ÿè¯„å®¡] Promptä¸­æ˜¯å¦åŒ…å«æµ‹è¯•ç”¨ä¾‹:', prompt.includes('GBM') || prompt.includes('PNT') || prompt.includes(fileContent.substring(0, 50)));
            console.log('[å¿«é€Ÿè¯„å®¡] å†…å®¹é¢„è§ˆ:', wrappedContent.substring(0, 300));
            
            // æ£€æŸ¥å†…å®¹é•¿åº¦ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†æ‰¹å¤„ç†
            const modelName = currentConfig.model || (activeModel === 'deepseek' ? 'deepseek-chat' : 'qwen-max');
            const lengthCheck = checkContentLength(wrappedContent, type.prompt, modelName);
            
            if (lengthCheck.needSplit) {
                console.log(`[å¿«é€Ÿè¯„å®¡] âš ï¸ å†…å®¹è¶…é•¿ (${lengthCheck.actualLength}/${lengthCheck.limit})ï¼Œå¯åŠ¨åˆ†æ‰¹è¯„å®¡`);
                showToast(`å†…å®¹è¾ƒå¤š(${testCaseCount || 'æœªçŸ¥'}æ¡ç”¨ä¾‹)ï¼Œå°†åˆ†æ‰¹è¿›è¡Œè¯„å®¡...`, 'success');
                
                // åˆ†å‰²å†…å®¹
                const chunks = splitTestCases(wrappedContent, lengthCheck.limit);
                console.log(`[å¿«é€Ÿè¯„å®¡] åˆ†å‰²ä¸º ${chunks.length} æ‰¹æ¬¡`);
                
                // æ·»åŠ åˆ†æ‰¹è¯´æ˜æ¶ˆæ¯
                addMessage('ai', `ğŸ“Š æ£€æµ‹åˆ°æµ‹è¯•ç”¨ä¾‹è¾ƒå¤šï¼Œå·²è‡ªåŠ¨åˆ†ä¸º ${chunks.length} æ‰¹æ¬¡è¿›è¡Œè¯„å®¡\n\næ­£åœ¨è¯„å®¡ç¬¬ 1/${chunks.length} æ‰¹æ¬¡...`);
                
                // é€æ‰¹å¤„ç†
                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    console.log(`[å¿«é€Ÿè¯„å®¡] å¤„ç†ç¬¬ ${i + 1}/${chunks.length} æ‰¹æ¬¡ï¼ŒåŒ…å« ${chunk.caseCount || 'æœªçŸ¥'} æ¡ç”¨ä¾‹`);
                    
                    // æ„å»ºåˆ†æ‰¹ prompt
                    let batchPrompt;
                    const batchInfo = `\n\nğŸ“‹ **æ‰¹æ¬¡ä¿¡æ¯**: ç¬¬ ${i + 1}/${chunks.length} æ‰¹${chunk.caseCount ? `ï¼ŒåŒ…å« ${chunk.caseCount} æ¡ç”¨ä¾‹` : ''}\n\n`;
                    
                    if (type.prompt.includes('{content}')) {
                        batchPrompt = type.prompt.replace('{content}', batchInfo + chunk.content);
                    } else {
                        batchPrompt = type.prompt + batchInfo + chunk.content;
                    }
                    
                    // æ˜¾ç¤ºè¿›åº¦
                    if (i > 0) {
                        addMessage('ai', `æ­£åœ¨è¯„å®¡ç¬¬ ${i + 1}/${chunks.length} æ‰¹æ¬¡...`);
                    }
                    
                    // è°ƒç”¨ API
                    await callAI(batchPrompt, true, false); // ä¸è§¦å‘ç»§ç»­è¯„å®¡æç¤º
                    
                    // æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…é¢‘ç‡é™åˆ¶
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                // æ‰€æœ‰æ‰¹æ¬¡å®Œæˆåï¼Œæ˜¾ç¤ºç»§ç»­è¯„å®¡æç¤º
                setTimeout(() => {
                    addMessage('ai', `âœ… å·²å®Œæˆæ‰€æœ‰ ${chunks.length} æ‰¹æ¬¡çš„è¯„å®¡ï¼`);
                    showNextFilePrompt();
                }, 1000);
                
            } else {
                // å†…å®¹æœªè¶…é•¿ï¼Œæ­£å¸¸å¤„ç†
                console.log(`[å¿«é€Ÿè¯„å®¡] âœ“ å†…å®¹é•¿åº¦æ­£å¸¸ (${lengthCheck.actualLength}/${lengthCheck.limit})ï¼Œå•æ¬¡è¯„å®¡`);
                await callAI(prompt, true, true); // ç¬¬ä¸‰ä¸ªå‚æ•°æ ‡è®°è¿™æ˜¯å¿«é€Ÿè¯„å®¡
            }
        }

        // æ£€æŸ¥å†…å®¹æ˜¯å¦è¶…è¿‡æ¨¡å‹é™åˆ¶
        function checkContentLength(content, promptTemplate, modelName) {
            const limit = MODEL_LIMITS[modelName] || 6000; // é»˜è®¤ä½¿ç”¨æœ€ä¿å®ˆçš„é™åˆ¶
            const templateLength = promptTemplate.length;
            const availableLength = limit - templateLength - 1000; // é¢„ç•™1000å­—ç¬¦ç»™ prompt æ¨¡æ¿å’ŒåŒ…è£…å†…å®¹
            
            console.log(`[é•¿åº¦æ£€æŸ¥] æ¨¡å‹: ${modelName}, é™åˆ¶: ${limit}, æ¨¡æ¿é•¿åº¦: ${templateLength}, å¯ç”¨é•¿åº¦: ${availableLength}, å®é™…å†…å®¹: ${content.length}`);
            
            return {
                exceeded: content.length > availableLength,
                limit: availableLength,
                actualLength: content.length,
                needSplit: content.length > availableLength
            };
        }

        // æ™ºèƒ½åˆ†å‰²æµ‹è¯•ç”¨ä¾‹å†…å®¹
        function splitTestCases(content, chunkSize) {
            const chunks = [];
            
            // æŒ‰ã€ç”¨ä¾‹ã€‘æ ‡è®°åˆ†å‰²ï¼ˆExcelæ ¼å¼ï¼‰
            if (content.includes('ã€ç”¨ä¾‹')) {
                const cases = content.split(/(?=ã€ç”¨ä¾‹ \d+ã€‘)/);
                let currentChunk = '';
                let chunkIndex = 0;
                
                for (const testCase of cases) {
                    if (!testCase.trim()) continue;
                    
                    if ((currentChunk + testCase).length > chunkSize && currentChunk) {
                        chunks.push({
                            index: chunkIndex++,
                            content: currentChunk,
                            caseCount: (currentChunk.match(/ã€ç”¨ä¾‹ \d+ã€‘/g) || []).length
                        });
                        currentChunk = testCase;
                    } else {
                        currentChunk += testCase;
                    }
                }
                
                if (currentChunk) {
                    chunks.push({
                        index: chunkIndex,
                        content: currentChunk,
                        caseCount: (currentChunk.match(/ã€ç”¨ä¾‹ \d+ã€‘/g) || []).length
                    });
                }
            } 
            // æŒ‰æ®µè½åˆ†å‰²ï¼ˆå…¶ä»–æ ¼å¼ï¼‰
            else {
                const lines = content.split('\n');
                let currentChunk = '';
                let chunkIndex = 0;
                
                for (const line of lines) {
                    if ((currentChunk + line + '\n').length > chunkSize && currentChunk) {
                        chunks.push({
                            index: chunkIndex++,
                            content: currentChunk,
                            caseCount: null
                        });
                        currentChunk = line + '\n';
                    } else {
                        currentChunk += line + '\n';
                    }
                }
                
                if (currentChunk) {
                    chunks.push({
                        index: chunkIndex,
                        content: currentChunk,
                        caseCount: null
                    });
                }
            }
            
            return chunks;
        }

        async function callAI(message, isSystemPrompt = false, isQuickReview = false) {
            const config = getConfig();
            const currentConfig = activeModel === 'deepseek' ? config.deepseek : config.qianwen;
            const sendBtn = document.getElementById('sendBtn');
            
            sendBtn.disabled = true;
            setStatus('loading', `æ­£åœ¨ä½¿ç”¨ ${activeModel === 'deepseek' ? 'DeepSeek' : 'åƒé—®'} æ€è€ƒä¸­...`);
            showTypingIndicator();

            try {
                // æ„å»ºæ¶ˆæ¯å†å²
                const messages = [];
                
                // æ·»åŠ ç³»ç»Ÿæç¤ºè¯
                messages.push({
                    role: 'system',
                    content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æµ‹è¯•å·¥ç¨‹å¸ˆ,æ“…é•¿æµ‹è¯•ç”¨ä¾‹è®¾è®¡ã€è¯„å®¡å’Œè´¨é‡åˆ†æã€‚'
                });
                
                if (isSystemPrompt) {
                    // å¿«é€Ÿè¯„å®¡æ¨¡å¼ï¼šåªå‘é€å½“å‰çš„ promptï¼Œä¸åŒ…å«å†å²å¯¹è¯
                    messages.push({ role: 'user', content: message });
                    console.log('[callAI] å¿«é€Ÿè¯„å®¡æ¨¡å¼');
                    console.log('[callAI] Prompt é•¿åº¦:', message.length);
                    console.log('[callAI] Prompt é¢„è§ˆ (å‰500å­—ç¬¦):', message.substring(0, 500));
                    console.log('[callAI] Prompt é¢„è§ˆ (å500å­—ç¬¦):', message.substring(Math.max(0, message.length - 500)));
                } else {
                    // æ™®é€šå¯¹è¯æ¨¡å¼ï¼šæ·»åŠ å†å²ä¸Šä¸‹æ–‡
                    const recentHistory = chatHistory.slice(-10);
                    for (const msg of recentHistory) {
                        if (msg.role === 'user' || msg.role === 'ai') {
                            messages.push({
                                role: msg.role === 'ai' ? 'assistant' : 'user',
                                content: msg.content
                            });
                        }
                    }
                    messages.push({ role: 'user', content: message });
                    console.log('[callAI] æ™®é€šå¯¹è¯æ¨¡å¼');
                    console.log('[callAI] æ¶ˆæ¯é•¿åº¦:', message.length);
                }

                console.log('[callAI] å‘é€æ¶ˆæ¯æ•°é‡:', messages.length);
                console.log('[callAI] ä½¿ç”¨æ¨¡å‹:', activeModel, currentConfig.model);

                let apiUrl, headers, requestBody;

                if (activeModel === 'deepseek') {
                    apiUrl = 'https://api.deepseek.com/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentConfig.apiKey}`
                    };
                    requestBody = {
                        model: currentConfig.model || 'deepseek-chat',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 8192, // å¢åŠ åˆ° 8Kï¼Œæ”¯æŒæ›´é•¿çš„è¯„å®¡è¾“å‡º
                        stream: false
                    };
                } else if (activeModel === 'qianwen') {
                    apiUrl = currentConfig.apiUrl || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentConfig.apiKey}`
                    };
                    // åƒé—®æ¨¡å‹çš„ max_tokens é™åˆ¶ï¼šqwen-max/plus æ”¯æŒ 8Kï¼Œqwen-long æ”¯æŒæ›´å¤§
                    const maxTokens = (currentConfig.model && currentConfig.model.includes('long')) ? 30000 : 8192;
                    requestBody = {
                        model: currentConfig.model || 'qwen-max',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: maxTokens // æ ¹æ®æ¨¡å‹åŠ¨æ€è®¾ç½®
                    };
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                removeTypingIndicator();

                if (!response.ok) {
                    console.error('API é”™è¯¯å“åº”:', data);
                    throw new Error(data.error?.message || data.message || 'è¯·æ±‚å¤±è´¥');
                }

                if (data.choices && data.choices.length > 0) {
                    const aiResponse = data.choices[0].message.content;
                    const finishReason = data.choices[0].finish_reason;
                    console.log('AI å“åº”é•¿åº¦:', aiResponse.length);
                    console.log('å®ŒæˆåŸå› :', finishReason);
                    
                    // æ£€æŸ¥å“åº”æ˜¯å¦å› ä¸ºé•¿åº¦è¢«æˆªæ–­
                    if (finishReason === 'length') {
                        console.warn('âš ï¸ AIå“åº”è¢«æˆªæ–­ï¼åŸå› ï¼šè¶…è¿‡max_tokensé™åˆ¶');
                        showToast('âš ï¸ AIå“åº”å¯èƒ½ä¸å®Œæ•´ï¼Œå»ºè®®ä½¿ç”¨qwen-longæ¨¡å‹æˆ–åˆ†æ‰¹è¯„å®¡', 'warning');
                    }
                    
                    addMessage('ai', aiResponse);
                    setStatus('connected', `å·²è¿æ¥ (${activeModel === 'deepseek' ? 'DeepSeek' : 'åƒé—®'})`);
                    
                    // å¦‚æœæ˜¯å¿«é€Ÿè¯„å®¡,æ˜¾ç¤ºç»§ç»­è¯„å®¡æç¤º
                    if (isQuickReview && currentFile) {
                        setTimeout(() => {
                            showNextFilePrompt();
                        }, 1000); // å»¶è¿Ÿ1ç§’æ˜¾ç¤º,è®©ç”¨æˆ·å…ˆçœ‹åˆ°è¯„å®¡ç»“æœ
                    }
                } else {
                    throw new Error('æœªè·å¾—æœ‰æ•ˆå“åº”');
                }
            } catch (err) {
                console.error('è°ƒç”¨ AI é”™è¯¯:', err);
                removeTypingIndicator();
                addMessage('ai', `âŒ é”™è¯¯ï¼š${err.message}`);
                setStatus('error', 'è¯·æ±‚å¤±è´¥');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function clearChat() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯å—ï¼Ÿ')) return;
            
            chatHistory = [];
            saveChatHistory();
            
            const container = document.getElementById('chatMessages');
            container.innerHTML = `
                <div class="message message-ai">
                    <div class="message-content">
ğŸ‘‹ <strong>å¯¹è¯å·²æ¸…ç©ºï¼</strong>

è¯·ä¸Šä¼ æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ï¼Œç„¶åé€‰æ‹©è¯„å®¡ç±»å‹æˆ–ç›´æ¥è¾“å…¥é—®é¢˜ã€‚</div>
                </div>
            `;
            
            showToast('å¯¹è¯å·²æ¸…ç©º', 'success');
        }

        function exportChat() {
            if (chatHistory.length === 0) {
                showToast('æš‚æ— å¯¹è¯è®°å½•', 'error');
                return;
            }

            let content = '# AIæ™ºèƒ½æµ‹è¯•ç”¨ä¾‹è¯„å®¡å¯¹è¯è®°å½•\n\n';
            content += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;
            content += '---\n\n';

            for (const msg of chatHistory) {
                const role = msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– AI';
                const time = new Date(msg.timestamp).toLocaleString();
                content += `### ${role} (${time})\n\n${msg.content}\n\n---\n\n`;
            }

            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¯¹è¯è®°å½•_${new Date().toISOString().slice(0, 10)}.md`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('å¯¹è¯å·²å¯¼å‡º', 'success');
        }

        // ==================== è¿æ¥æµ‹è¯• ====================
        async function testConnection(provider) {
            const config = getConfig();
            const currentConfig = provider === 'deepseek' ? config.deepseek : config.qianwen;
            
            if (!currentConfig?.apiKey) {
                showToast(`è¯·è¾“å…¥ ${provider === 'deepseek' ? 'DeepSeek' : 'åƒé—®'} API Key`, 'error');
                return;
            }

            showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

            try {
                let apiUrl, headers, requestBody;

                if (provider === 'deepseek') {
                    apiUrl = 'https://api.deepseek.com/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentConfig.apiKey}`
                    };
                    requestBody = {
                        model: currentConfig.model || 'deepseek-chat',
                        messages: [{ role: 'user', content: 'ä½ å¥½' }],
                        max_tokens: 10
                    };
                } else if (provider === 'qianwen') {
                    apiUrl = currentConfig.apiUrl || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentConfig.apiKey}`
                    };
                    requestBody = {
                        model: currentConfig.model || 'qwen-max',
                        messages: [{ role: 'user', content: 'ä½ å¥½' }],
                        max_tokens: 10
                    };
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    showToast(`âœ… ${provider === 'deepseek' ? 'DeepSeek' : 'åƒé—®'} è¿æ¥æˆåŠŸï¼`, 'success');
                } else {
                    const data = await response.json();
                    showToast(`âŒ è¿æ¥å¤±è´¥ï¼š${data.error?.message || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (err) {
                showToast('âŒ è¿æ¥å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        // ==================== UI è¾…åŠ©å‡½æ•° ====================
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            if (modalId === 'reviewTypesModal') {
                renderReviewTypesList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function updateStatus() {
            const config = getConfig();
            const hasDeepseek = config.deepseek?.apiKey;
            const hasQianwen = config.qianwen?.apiKey;
            
            if (hasDeepseek || hasQianwen) {
                const status = [];
                if (hasDeepseek) status.push('DeepSeek');
                if (hasQianwen) status.push('åƒé—®');
                setStatus('connected', `å·²é…ç½®: ${status.join(' + ')}`);
            } else {
                setStatus('disconnected', 'æœªé…ç½® API Key');
            }
        }

        function setStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            
            dot.className = 'status-dot';
            if (status === 'loading') {
                dot.classList.add('loading');
            } else if (status === 'disconnected' || status === 'error') {
                dot.classList.add('disconnected');
            }
            
            textEl.textContent = 'æœåŠ¡çŠ¶æ€: ' + text;
        }

        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // ==================== æ–‡ä»¶ç®¡ç†åŠŸèƒ½ ====================
        function changeFile() {
            const reviewSummary = currentFileReviewHistory.length > 0 
                ? `\n\nå·²å®Œæˆè¯„å®¡: ${currentFileReviewHistory.map(h => h.typeName).join(', ')}`
                : '';
            
            if (confirm('æ˜¯å¦è¦æ›´æ¢å½“å‰æ–‡ä»¶?' + reviewSummary + '\n\nå½“å‰æ–‡ä»¶: ' + (currentFile ? currentFile.name : 'æ— ') + '\n\nç‚¹å‡»"ç¡®å®š"é€‰æ‹©æ–°æ–‡ä»¶')) {
                document.getElementById('fileInput').click();
            }
        }

        function clearCurrentFile() {
            if (!currentFile) {
                showToast('å½“å‰æ²¡æœ‰å·²åŠ è½½çš„æ–‡ä»¶', 'info');
                return;
            }

            const reviewSummary = currentFileReviewHistory.length > 0 
                ? `\nå·²å®Œæˆè¯„å®¡: ${currentFileReviewHistory.map(h => h.typeName).join(', ')}\n`
                : '';

            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰æ–‡ä»¶å—?\n\næ–‡ä»¶: ' + currentFile.name + '\nå†…å®¹: ' + fileContent.length + ' å­—ç¬¦' + reviewSummary + '\n\næ¸…é™¤åéœ€è¦é‡æ–°ä¸Šä¼ æ–‡ä»¶æ‰èƒ½è¿›è¡Œè¯„å®¡ã€‚')) {
                currentFile = null;
                fileContent = '';
                currentFileReviewHistory = []; // é‡ç½®è¯„å®¡å†å²
                
                // éšè—æ–‡ä»¶ä¿¡æ¯
                document.getElementById('fileInfo').style.display = 'none';
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                document.getElementById('fileInput').value = '';
                
                // æ›´æ–°çŠ¶æ€æ 
                document.getElementById('fileStatusBar').textContent = '';
                
                // ç¦ç”¨å¿«é€Ÿè¯„å®¡æŒ‰é’®
                renderQuickReviewButtons();
                
                showToast('æ–‡ä»¶å·²æ¸…é™¤', 'success');
                
                console.log('[æ–‡ä»¶ç®¡ç†] å½“å‰æ–‡ä»¶å·²æ¸…é™¤');
            }
        }

        function showNextFilePrompt() {
            // è·å–æ‰€æœ‰è¯„å®¡ç±»å‹
            const allTypes = loadReviewTypes();
            
            // æ‰¾å‡ºæœªè¯„å®¡çš„ç±»å‹
            const reviewedTypeIds = currentFileReviewHistory.map(h => h.typeId);
            const unreviewedTypes = allTypes.filter(t => !reviewedTypeIds.includes(t.id));
            
            console.log('[æç¤ºæ¡†] å·²è¯„å®¡ç±»å‹:', reviewedTypeIds);
            console.log('[æç¤ºæ¡†] æœªè¯„å®¡ç±»å‹:', unreviewedTypes.map(t => t.name));
            
            // æ ¹æ®æœªè¯„å®¡ç±»å‹æ•°é‡å†³å®šæç¤ºå†…å®¹
            let promptHtml;
            
            if (unreviewedTypes.length > 0) {
                // è¿˜æœ‰æœªè¯„å®¡çš„ç±»å‹ï¼Œæä¾›å¿«é€Ÿè¯„å®¡æŒ‰é’®
                const quickReviewButtons = unreviewedTypes.map(type => `
                    <button onclick="closeNextFilePrompt(); quickReview('${type.id}')" 
                            style="flex: 1; padding: 10px 14px; background: linear-gradient(135deg, ${getTypeGradient(type.color)}); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        ${type.icon} ${type.name}
                    </button>
                `).join('');
                
                promptHtml = `
                    <div style="background: #F0FDF4; border: 2px solid #10B981; border-radius: 12px; padding: 16px; margin: 10px 0;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">âœ…</span>
                            <strong style="color: #059669; font-size: 15px;">è¯„å®¡å®Œæˆ!</strong>
                        </div>
                        <div style="color: #1F2937; font-size: 14px; margin-bottom: 12px;">
                            å½“å‰æ–‡ä»¶ <strong>${currentFile ? currentFile.name : 'æœªçŸ¥'}</strong> çš„ <span style="color: #059669; font-weight: 600;">${currentFileReviewHistory[currentFileReviewHistory.length - 1].typeName}</span> å·²è¯„å®¡å®Œæˆã€‚
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #6B7280; margin-bottom: 8px;">
                                ğŸ’¡ è¿˜æœ‰ <strong style="color: #10B981;">${unreviewedTypes.length}</strong> ç§è¯„å®¡ç±»å‹æœªè¿›è¡Œï¼š
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                ${quickReviewButtons}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="changeFile()" style="flex: 1; padding: 10px 14px; background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                                ğŸ“ æ›´æ¢æ–‡ä»¶
                            </button>
                            <button onclick="closeNextFilePrompt()" style="flex: 1; padding: 10px 14px; background: white; color: #6B7280; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                                â¸ï¸ æš‚ä¸è¯„å®¡
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // æ‰€æœ‰ç±»å‹éƒ½å·²è¯„å®¡ï¼Œä»…æç¤ºæ›´æ¢æ–‡ä»¶
                promptHtml = `
                    <div style="background: #EFF6FF; border: 2px solid #3B82F6; border-radius: 12px; padding: 16px; margin: 10px 0;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">ğŸ‰</span>
                            <strong style="color: #1E40AF; font-size: 15px;">å…¨éƒ¨è¯„å®¡å®Œæˆ!</strong>
                        </div>
                        <div style="color: #1F2937; font-size: 14px; margin-bottom: 12px;">
                            å½“å‰æ–‡ä»¶ <strong>${currentFile ? currentFile.name : 'æœªçŸ¥'}</strong> çš„æ‰€æœ‰è¯„å®¡ç±»å‹å·²å®Œæˆã€‚
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #6B7280;">
                                âœ“ å·²å®Œæˆ <strong>${currentFileReviewHistory.length}</strong> ç§è¯„å®¡ç±»å‹ï¼š
                                <span style="color: #3B82F6; font-weight: 500;">${currentFileReviewHistory.map(h => h.typeName).join(', ')}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="changeFile()" style="flex: 1; padding: 10px 14px; background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                                ğŸ“ è¯„å®¡ä¸‹ä¸€ä¸ªæ–‡ä»¶
                            </button>
                            <button onclick="closeNextFilePrompt()" style="flex: 1; padding: 10px 14px; background: white; color: #6B7280; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                                â¸ï¸ æš‚ä¸è¯„å®¡
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // åœ¨èŠå¤©åŒºåŸŸåº•éƒ¨æ·»åŠ æç¤º
            const chatMessages = document.getElementById('chatMessages');
            const promptDiv = document.createElement('div');
            promptDiv.id = 'nextFilePrompt';
            promptDiv.className = 'message';
            promptDiv.innerHTML = promptHtml;
            chatMessages.appendChild(promptDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ç±»å‹é¢œè‰²è¿”å›æ¸å˜è‰²
        function getTypeGradient(color) {
            const gradients = {
                'boundary': '#6366F1 0%, #8B5CF6 100%',
                'ambiguity': '#10B981 0%, #34D399 100%',
                'format': '#F59E0B 0%, #FBBF24 100%',
                'custom': '#EC4899 0%, #F472B6 100%'
            };
            return gradients[color] || gradients['custom'];
        }

        function closeNextFilePrompt() {
            const prompt = document.getElementById('nextFilePrompt');
            if (prompt) {
                prompt.remove();
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
