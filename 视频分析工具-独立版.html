<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†é¢‘é€å¸§åˆ†æä¸AIæç¤ºè¯ç”Ÿæˆ - ç‹¬ç«‹ç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .config-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #666;
      font-size: 0.9em;
    }

    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .warning-box strong {
      color: #856404;
    }

    .warning-box p {
      margin: 8px 0 0 0;
      color: #856404;
      font-size: 0.95em;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-box h4 {
      color: #1976d2;
      margin-bottom: 8px;
    }

    .info-box ul {
      margin-left: 20px;
      color: #555;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }

    .upload-area:hover {
      background: #f0f4ff;
      border-color: #764ba2;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      width: 100%;
      margin-top: 20px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .progress-section {
      display: none;
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-top: 30px;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      width: 0%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .results {
      display: none;
      margin-top: 30px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .results-header h2 {
      color: #667eea;
    }

    .export-btn {
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      margin-left: 10px;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .result-item {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      animation: fadeIn 0.5s;
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-item-inner {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .result-item-image {
      flex-shrink: 0;
      flex-grow: 0;
      width: auto;
    }

    .result-item img {
      width: auto;
      height: auto;
      max-width: 350px;
      max-height: 500px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      display: block;
    }

    .result-content {
      flex: 1;
      min-width: 0;
    }

    .result-content h3 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .result-content .timestamp {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 15px;
    }

    .result-content .prompt {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      line-height: 1.6;
      position: relative;
    }

    .copy-prompt-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: bold;
      transition: all 0.2s;
      z-index: 10;
    }

    .copy-prompt-btn:hover {
      background: #764ba2;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .copy-prompt-btn:active {
      transform: translateY(0);
    }

    .copy-prompt-btn.copied {
      background: #28a745;
    }

    .prompt-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: none;
      overflow: visible;
    }
    
    .prompt-text.collapsed {
      max-height: 150px;
      overflow: hidden;
      position: relative;
    }
    
    .prompt-text.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
      pointer-events: none;
    }

    .prompt-text.expanded {
      max-height: none;
      overflow: visible;
    }
    
    .prompt-text.expanded::after {
      display: none;
    }

    .expand-btn {
      display: inline-block;
      margin-top: 8px;
      color: #667eea;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9em;
      user-select: none;
    }

    .expand-btn:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    .api-config {
      display: none;
    }

    .api-config.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ è§†é¢‘é€å¸§åˆ†æç³»ç»Ÿ</h1>
      <p>ä¸Šä¼ è§†é¢‘ï¼ŒAIè‡ªåŠ¨ç”Ÿæˆæ¯å¸§ç”»é¢çš„è¯¦ç»†æç¤ºè¯</p>
    </div>

    <div class="content">
      <!-- è¯´æ˜ä¿¡æ¯ -->
      <div class="info-box">
        <h4>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h4>
        <ul>
          <li>æ”¯æŒçš„è§†é¢‘æ ¼å¼ï¼šMP4ã€AVIã€MOVã€MKVã€WebMç­‰</li>
          <li>å¸§é—´éš”ï¼šè®¾ç½®æ¯éš”å¤šå°‘ç§’æå–ä¸€å¸§ï¼ˆå»ºè®®3-5ç§’ï¼‰</li>
          <li>æ‰€æœ‰å¤„ç†åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œè§†é¢‘ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
          <li>AIåˆ†æéœ€è¦æœ‰æ•ˆçš„APIå¯†é’¥</li>
          <li><strong>ğŸ’¡ å¿«é€Ÿé…ç½®ï¼š</strong>å¯ä»¥å¯¼å…¥.envæ–‡ä»¶ä¸€é”®åŠ è½½é…ç½®ï¼Œæˆ–æ‰‹åŠ¨å¡«å†™API Key</li>
        </ul>
      </div>

      <!-- CORSè­¦å‘Š -->
      <div class="warning-box" id="corsWarning" style="display: none;">
        <strong>âš ï¸ æ£€æµ‹åˆ°CORSè·¨åŸŸé—®é¢˜</strong>
        <p>
          ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæœ¬é¡µé¢éœ€è¦é€šè¿‡HTTPæœåŠ¡å™¨è¿è¡Œæ‰èƒ½æ­£å¸¸è°ƒç”¨AI APIã€‚<br>
          <strong>è§£å†³æ–¹æ³•ï¼š</strong>
        </p>
        <ol style="margin: 10px 0 0 20px; color: #856404;">
          <li>å‘½ä»¤è¡Œè¿è¡Œ: <code style="background: white; padding: 2px 6px; border-radius: 3px;">python -m http.server 8080</code></li>
          <li>ç„¶åè®¿é—®: <code style="background: white; padding: 2px 6px; border-radius: 3px;">http://localhost:8080/è§†é¢‘åˆ†æå·¥å…·-ç‹¬ç«‹ç‰ˆ.html</code></li>
          <li>æˆ–ä½¿ç”¨å®Œæ•´çš„æœåŠ¡å™¨ç‰ˆæœ¬: <code style="background: white; padding: 2px 6px; border-radius: 3px;">node server.js</code></li>
        </ol>
      </div>

      <!-- APIé…ç½® -->
      <div class="config-section">
        <h3 style="margin-bottom: 20px;">âš™ï¸ APIé…ç½®</h3>

        <div class="form-group">
          <label>é€‰æ‹©AIå¹³å°</label>
          <select id="apiProvider">
            <option value="qwen">åƒé—® (Qwen)</option>
            <option value="volcengine">ç«å±±å¼•æ“</option>
            <option value="deepseek" disabled>DeepSeek (æš‚ä¸æ”¯æŒ)</option>
          </select>
        </div>

        <!-- åƒé—®é…ç½® -->
        <div id="qwenConfig" class="api-config active">
          <div class="form-group">
            <label>åƒé—® API Key</label>
            <input type="password" id="qwenApiKey" placeholder="sk-...">
            <small>è·å–åœ°å€: <a href="https://dashscope.console.aliyun.com/apiKey" target="_blank">https://dashscope.console.aliyun.com/apiKey</a></small>
          </div>
          <div class="form-group">
            <label>æ¨¡å‹åç§°</label>
            <input type="text" id="qwenModel" value="qwen-vl-max" placeholder="qwen-vl-max">
            <small>å®˜æ–¹æ¨è: qwen-vl-max æˆ– qwen-vl-plus</small>
          </div>
          <div class="form-group">
            <label>API ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="qwenBaseUrl" value="" placeholder="ç•™ç©ºä½¿ç”¨å®˜æ–¹APIï¼Œæˆ–å¡«å†™è‡ªå»ºæœåŠ¡åœ°å€">
            <small>ğŸ’¡ ç•™ç©ºåˆ™ä½¿ç”¨é˜¿é‡Œäº‘å®˜æ–¹APIï¼›å¡«å†™åˆ™ä½¿ç”¨è‡ªå»ºæœåŠ¡ï¼ˆå¦‚ï¼šhttp://43.173.153.29:11436/v1/chat/completionsï¼‰</small>
          </div>
        </div>

        <!-- ç«å±±å¼•æ“é…ç½® -->
        <div id="volcengineConfig" class="api-config">
          <div class="form-group">
            <label>ç«å±±å¼•æ“ API Key</label>
            <input type="password" id="volcengineApiKey" placeholder="your_api_key">
            <small>è·å–åœ°å€: <a href="https://console.volcengine.com/" target="_blank">https://console.volcengine.com/</a></small>
          </div>
          <div class="form-group">
            <label>æ¨¡å‹åç§°</label>
            <input type="text" id="volcengineModel" placeholder="doubao-vision-pro-32k">
            <small>ä¾‹å¦‚: doubao-vision-pro-32k</small>
          </div>
          <div class="form-group">
            <label>APIåœ°å€</label>
            <input type="text" id="volcengineBaseUrl" value="https://ark.cn-beijing.volces.com/api/v3">
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" id="loadEnvBtn" style="width: auto; padding: 10px 30px; background: #17a2b8;">ğŸ“ å¯¼å…¥.envæ–‡ä»¶</button>
          <button class="btn" id="saveConfigBtn" style="width: auto; padding: 10px 30px;">ğŸ’¾ ä¿å­˜é…ç½®</button>
          <button class="btn" id="downloadEnvBtn" style="width: auto; padding: 10px 30px; background: #6c757d;">ğŸ“¥ ä¸‹è½½.envæ¨¡æ¿</button>
        </div>
        <input type="file" id="envFileInput" accept=".env" style="display: none;">
      </div>

      <!-- è§†é¢‘ä¸Šä¼  -->
      <div class="config-section">
        <h3 style="margin-bottom: 20px;">ğŸ“¹ è§†é¢‘åˆ†æ</h3>

        <div class="form-group">
          <label>æå–æ¨¡å¼</label>
          <select id="extractMode">
            <option value="smart">ğŸ¬ æ™ºèƒ½åˆ†é•œæ¨¡å¼ï¼ˆæ¨èï¼‰</option>
            <option value="fixed">â±ï¸ å›ºå®šé—´éš”æ¨¡å¼</option>
          </select>
          <small id="modeDescription">è‡ªåŠ¨æ£€æµ‹é•œå¤´åˆ‡æ¢ï¼Œæ•è·ç”»é¢ç²¾åï¼Œè¿‡æ»¤å…¨é»‘å…¨ç™½å¸§</small>
        </div>

        <div id="fixedModeSettings" style="display: none;">
          <div class="form-group">
            <label>å¸§æå–é—´éš”ï¼ˆç§’ï¼‰</label>
            <input type="number" id="frameInterval" value="5" min="1" max="10">
            <small>å€¼è¶Šå°å¸§æ•°è¶Šå¤šï¼Œå¤„ç†æ—¶é—´è¶Šé•¿</small>
          </div>
        </div>

        <div id="smartModeSettings">
          <div class="form-group">
            <label>åˆ†é•œæ•æ„Ÿåº¦</label>
            <select id="sceneSensitivity">
              <option value="low">ä½ï¼ˆå¤§å¹…åº¦å˜åŒ–ï¼‰</option>
              <option value="medium" selected>ä¸­ï¼ˆæ¨èï¼‰</option>
              <option value="high">é«˜ï¼ˆç»†å¾®å˜åŒ–ï¼‰</option>
            </select>
            <small>æ§åˆ¶é•œå¤´åˆ‡æ¢æ£€æµ‹çš„çµæ•åº¦</small>
          </div>

          <div class="form-group">
            <label>å†…å®¹è´¨é‡é˜ˆå€¼</label>
            <input type="range" id="qualityThreshold" min="0" max="100" value="30" step="5">
            <small>å½“å‰å€¼: <span id="qualityValue">30</span> - è¿‡æ»¤ä½è´¨é‡ç”»é¢ï¼ˆå…¨é»‘ã€å…¨ç™½ã€æ¨¡ç³Šï¼‰</small>
          </div>

          <div class="form-group">
            <label>æœ€å°åˆ†é•œé—´éš”ï¼ˆç§’ï¼‰</label>
            <input type="number" id="minSceneInterval" value="2" min="0.5" max="10" step="0.5">
            <small>é¿å…åŒä¸€é•œå¤´æå–è¿‡å¤šå¸§</small>
          </div>
        </div>

        <div class="form-group">
          <label>ä¸Šä¼ è§†é¢‘æ–‡ä»¶</label>
          <div class="upload-area" id="uploadArea">
            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“¹</div>
            <p style="font-size: 1.2em; margin-bottom: 10px;">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <p style="color: #666;">æ”¯æŒ MP4, AVI, MOV, MKV, WebM ç­‰æ ¼å¼</p>
            <input type="file" id="videoInput" accept="video/*" style="display: none;">
          </div>
        </div>

        <button class="btn" id="analyzeBtn">å¼€å§‹åˆ†æ</button>
      </div>

      <!-- è¿›åº¦æ˜¾ç¤º -->
      <div class="progress-section" id="progressSection">
        <div class="progress-info">
          <h3 id="progressStatus">æ­£åœ¨å¤„ç†...</h3>
          <span id="progressPercent" style="font-size: 1.5em; font-weight: bold; color: #667eea;">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progressBarFill">
            <span id="progressText"></span>
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em; color: #666;">
          <span id="progressDetail">æ€»å…± 0 å¸§</span>
          <span id="progressTime">é¢„è®¡å‰©ä½™: --</span>
        </div>
      </div>

      <!-- ç»“æœæ˜¾ç¤º -->
      <div class="results" id="results">
        <div class="results-header">
          <h2>åˆ†æç»“æœ</h2>
          <div>
            <button class="export-btn" id="exportTxtBtn">ğŸ“„ å¯¼å‡ºTXT</button>
            <button class="export-btn" id="exportJsonBtn" style="background: #6f42c1;">ğŸ“‹ å¯¼å‡ºJSON</button>
            <button class="export-btn" id="copyAllBtn" style="background: #fd7e14;">ğŸ“‘ å¤åˆ¶å…¨éƒ¨</button>
          </div>
        </div>
        <div id="resultsContainer"></div>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display: none;"></canvas>
  <video id="videoPreview" style="display: none;"></video>

  <script>
    // DOMå…ƒç´ 
    const apiProvider = document.getElementById('apiProvider');
    const uploadArea = document.getElementById('uploadArea');
    const videoInput = document.getElementById('videoInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const progressSection = document.getElementById('progressSection');
    const progressBarFill = document.getElementById('progressBarFill');
    const results = document.getElementById('results');
    const resultsContainer = document.getElementById('resultsContainer');
    const videoPreview = document.getElementById('videoPreview');
    const canvas = document.getElementById('canvas');
    const exportTxtBtn = document.getElementById('exportTxtBtn');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const loadEnvBtn = document.getElementById('loadEnvBtn');
    const downloadEnvBtn = document.getElementById('downloadEnvBtn');
    const envFileInput = document.getElementById('envFileInput');

    let analysisResults = [];
    let processingStartTime = 0;

    // é¡µé¢åŠ è½½æ—¶ä»localStorageåŠ è½½é…ç½®
    window.addEventListener('DOMContentLoaded', () => {
      loadSavedConfig();
    });

    // APIå¹³å°åˆ‡æ¢
    apiProvider.addEventListener('change', (e) => {
      document.querySelectorAll('.api-config').forEach(el => el.classList.remove('active'));
      document.getElementById(e.target.value + 'Config').classList.add('active');
    });

    // æå–æ¨¡å¼åˆ‡æ¢
    const extractMode = document.getElementById('extractMode');
    const fixedModeSettings = document.getElementById('fixedModeSettings');
    const smartModeSettings = document.getElementById('smartModeSettings');
    const modeDescription = document.getElementById('modeDescription');
    const qualityThreshold = document.getElementById('qualityThreshold');
    const qualityValue = document.getElementById('qualityValue');

    extractMode.addEventListener('change', (e) => {
      if (e.target.value === 'fixed') {
        fixedModeSettings.style.display = 'block';
        smartModeSettings.style.display = 'none';
        modeDescription.textContent = 'æŒ‰å›ºå®šæ—¶é—´é—´éš”æå–è§†é¢‘å¸§';
      } else {
        fixedModeSettings.style.display = 'none';
        smartModeSettings.style.display = 'block';
        modeDescription.textContent = 'è‡ªåŠ¨æ£€æµ‹é•œå¤´åˆ‡æ¢ï¼Œæ•è·ç”»é¢ç²¾åï¼Œè¿‡æ»¤å…¨é»‘å…¨ç™½å¸§';
      }
    });

    // è´¨é‡é˜ˆå€¼æ»‘å—
    qualityThreshold.addEventListener('input', (e) => {
      qualityValue.textContent = e.target.value;
    });

    // ä¸Šä¼ åŒºåŸŸäº¤äº’
    uploadArea.addEventListener('click', () => videoInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.background = '#f0f4ff';
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.background = 'white';
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.background = 'white';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        videoInput.files = files;
        updateUploadAreaText(files[0].name);
      }
    });

    videoInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        updateUploadAreaText(e.target.files[0].name);
      }
    });

    function updateUploadAreaText(filename) {
      uploadArea.innerHTML = `
        <div style="font-size: 3em; margin-bottom: 15px; color: #4caf50;">âœ“</div>
        <p style="font-size: 1.2em; margin-bottom: 10px;">å·²é€‰æ‹©æ–‡ä»¶</p>
        <p style="color: #667eea; font-weight: bold;">${filename}</p>
      `;
    }

    // ä¿å­˜é…ç½®
    saveConfigBtn.addEventListener('click', () => {
      const config = getAPIConfig();
      localStorage.setItem('videoAnalyzerConfig', JSON.stringify(config));
      alert('âœ… é…ç½®å·²ä¿å­˜åˆ°æµè§ˆå™¨ï¼');
    });

    // å¯¼å…¥.envæ–‡ä»¶
    loadEnvBtn.addEventListener('click', () => {
      envFileInput.click();
    });

    envFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const config = parseEnvFile(text);
        
        // åº”ç”¨é…ç½®åˆ°ç•Œé¢
        if (config.API_PROVIDER) {
          const provider = config.API_PROVIDER.toLowerCase();
          if (provider === 'qwen' || provider === 'volcengine') {
            apiProvider.value = provider;
            apiProvider.dispatchEvent(new Event('change'));
          }
        }

        // åƒé—®é…ç½®
        if (config.QWEN_API_KEY) {
          document.getElementById('qwenApiKey').value = config.QWEN_API_KEY;
        }
        if (config.QWEN_MODEL) {
          document.getElementById('qwenModel').value = config.QWEN_MODEL;
        }
        if (config.QWEN_BASE_URL) {
          document.getElementById('qwenBaseUrl').value = config.QWEN_BASE_URL;
        }

        // ç«å±±å¼•æ“é…ç½®
        if (config.VOLCENGINE_API_KEY) {
          document.getElementById('volcengineApiKey').value = config.VOLCENGINE_API_KEY;
        }
        if (config.VOLCENGINE_MODEL) {
          document.getElementById('volcengineModel').value = config.VOLCENGINE_MODEL;
        }
        if (config.VOLCENGINE_BASE_URL) {
          document.getElementById('volcengineBaseUrl').value = config.VOLCENGINE_BASE_URL;
        }

        // å¸§é—´éš”é…ç½®
        if (config.FRAME_INTERVAL) {
          document.getElementById('frameInterval').value = config.FRAME_INTERVAL;
        }

        alert('âœ… .envæ–‡ä»¶åŠ è½½æˆåŠŸï¼è¯·ç‚¹å‡»"ğŸ’¾ ä¿å­˜é…ç½®"ä»¥ä¿å­˜åˆ°æµè§ˆå™¨ã€‚');
        
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
        envFileInput.value = '';
      } catch (error) {
        console.error('è¯»å–.envæ–‡ä»¶å¤±è´¥:', error);
        alert('âŒ .envæ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
      }
    });

    // ä¸‹è½½.envæ¨¡æ¿
    downloadEnvBtn.addEventListener('click', () => {
      const currentConfig = getAPIConfig();
      const provider = currentConfig.provider;
      
      let envContent = `# è§†é¢‘åˆ†æç³»ç»Ÿé…ç½®æ–‡ä»¶
# ç”Ÿæˆæ—¶é—´: ${new Date().toISOString().split('T')[0]}

# é€‰æ‹©ä½¿ç”¨çš„APIæœåŠ¡: volcengine, qwen
API_PROVIDER=${provider}

# åƒé—®é…ç½®
QWEN_API_KEY=${currentConfig.qwen.apiKey || 'sk-your-qwen-api-key-here'}
QWEN_MODEL=${currentConfig.qwen.model || 'qwen-vl-max'}
QWEN_BASE_URL=${currentConfig.qwen.baseUrl || ''}  # ç•™ç©ºä½¿ç”¨å®˜æ–¹APIï¼Œå¡«å†™åˆ™ä½¿ç”¨è‡ªå»ºæœåŠ¡

# ç«å±±å¼•æ“é…ç½®
VOLCENGINE_API_KEY=${currentConfig.volcengine.apiKey || 'your-volcengine-api-key-here'}
VOLCENGINE_MODEL=${currentConfig.volcengine.model || 'doubao-vision-pro-32k'}
VOLCENGINE_BASE_URL=${currentConfig.volcengine.baseUrl || 'https://ark.cn-beijing.volces.com/api/v3'}

# å¸§æå–é…ç½®
FRAME_INTERVAL=${document.getElementById('frameInterval').value}
`;

      downloadFile(envContent, '.env', 'text/plain');
      alert('âœ… .envé…ç½®æ–‡ä»¶å·²ä¸‹è½½ï¼\n\nä¸‹æ¬¡å¯ä»¥é€šè¿‡"ğŸ“ å¯¼å…¥.envæ–‡ä»¶"æŒ‰é’®å¿«é€ŸåŠ è½½é…ç½®ã€‚');
    });

    // è§£æ.envæ–‡ä»¶
    function parseEnvFile(text) {
      const config = {};
      const lines = text.split('\n');
      
      for (const line of lines) {
        // è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
        const trimmed = line.trim();
        if (!trimmed || trimmed.startsWith('#')) continue;
        
        // è§£æé”®å€¼å¯¹
        const equalIndex = trimmed.indexOf('=');
        if (equalIndex === -1) continue;
        
        const key = trimmed.substring(0, equalIndex).trim();
        let value = trimmed.substring(equalIndex + 1).trim();
        
        // ç§»é™¤å¼•å·
        if ((value.startsWith('"') && value.endsWith('"')) || 
            (value.startsWith("'") && value.endsWith("'"))) {
          value = value.substring(1, value.length - 1);
        }
        
        config[key] = value;
      }
      
      return config;
    }

    // åŠ è½½ä¿å­˜çš„é…ç½®
    function loadSavedConfig() {
      const saved = localStorage.getItem('videoAnalyzerConfig');
      if (saved) {
        const config = JSON.parse(saved);
        apiProvider.value = config.provider || 'qwen';
        apiProvider.dispatchEvent(new Event('change'));

        if (config.qwen) {
          document.getElementById('qwenApiKey').value = config.qwen.apiKey || '';
          document.getElementById('qwenModel').value = config.qwen.model || 'qwen-vl-max';
          document.getElementById('qwenBaseUrl').value = config.qwen.baseUrl || '';
        }
        if (config.volcengine) {
          document.getElementById('volcengineApiKey').value = config.volcengine.apiKey || '';
          document.getElementById('volcengineModel').value = config.volcengine.model || '';
          document.getElementById('volcengineBaseUrl').value = config.volcengine.baseUrl || '';
        }
      }
    }

    // è·å–å½“å‰é…ç½®
    function getAPIConfig() {
      const provider = apiProvider.value;
      return {
        provider: provider,
        qwen: {
          apiKey: document.getElementById('qwenApiKey').value,
          model: document.getElementById('qwenModel').value,
          baseUrl: document.getElementById('qwenBaseUrl').value
        },
        volcengine: {
          apiKey: document.getElementById('volcengineApiKey').value,
          model: document.getElementById('volcengineModel').value,
          baseUrl: document.getElementById('volcengineBaseUrl').value
        }
      };
    }

    // å¼€å§‹åˆ†æ
    analyzeBtn.addEventListener('click', async () => {
      if (!videoInput.files[0]) {
        alert('è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼');
        return;
      }

      const config = getAPIConfig();
      const provider = config.provider;
      
      let apiKey, model, baseUrl;
      if (provider === 'qwen') {
        apiKey = config.qwen.apiKey;
        model = config.qwen.model;
        baseUrl = config.qwen.baseUrl;
      } else if (provider === 'volcengine') {
        apiKey = config.volcengine.apiKey;
        model = config.volcengine.model;
        baseUrl = config.volcengine.baseUrl;
      }

      if (!apiKey) {
        alert('è¯·å¡«å†™API Keyï¼');
        return;
      }

      analyzeBtn.disabled = true;
      progressSection.style.display = 'block';
      results.style.display = 'none';
      analysisResults = [];
      processingStartTime = Date.now();

      try {
        // æå–è§†é¢‘å¸§
        updateProgress(0, 'æ­£åœ¨æå–è§†é¢‘å¸§...', 0, 0);
        const frames = await extractFrames();
        
        if (frames.length === 0) {
          throw new Error('æœªèƒ½æå–åˆ°è§†é¢‘å¸§');
        }

        console.log(`æˆåŠŸæå– ${frames.length} å¸§`);

        // AIåˆ†ææ¯ä¸€å¸§
        const totalFrames = frames.length;
        for (let i = 0; i < frames.length; i++) {
          const currentFrame = i + 1;
          const percent = ((currentFrame - 1) / totalFrames) * 100;
          
          // è®¡ç®—é¢„è®¡å‰©ä½™æ—¶é—´
          const elapsed = (Date.now() - processingStartTime) / 1000;
          const avgTimePerFrame = elapsed / currentFrame;
          const remainingFrames = totalFrames - currentFrame;
          const remainingSeconds = avgTimePerFrame * remainingFrames;

          updateProgress(
            percent,
            `æ­£åœ¨åˆ†æç¬¬ ${currentFrame}/${totalFrames} å¸§`,
            currentFrame,
            totalFrames,
            remainingSeconds
          );
          
          try {
            const prompt = await analyzeFrame(frames[i].dataUrl, { provider, apiKey, model, baseUrl });
            analysisResults.push({
              frameNumber: i + 1,
              timestamp: frames[i].timestamp,
              dataUrl: frames[i].dataUrl,
              prompt: prompt,
              sceneNumber: frames[i].sceneNumber,  // æ™ºèƒ½åˆ†é•œç¼–å·
              quality: frames[i].quality           // ç”»é¢è´¨é‡åˆ†æ•°
            });
            console.log(`å¸§ ${i + 1} åˆ†æå®Œæˆ`);
          } catch (error) {
            console.error(`å¸§ ${i + 1} åˆ†æå¤±è´¥:`, error);
            analysisResults.push({
              frameNumber: i + 1,
              timestamp: frames[i].timestamp,
              dataUrl: frames[i].dataUrl,
              prompt: `åˆ†æå¤±è´¥: ${error.message}`,
              sceneNumber: frames[i].sceneNumber,
              quality: frames[i].quality
            });
          }
        }

        updateProgress(100, 'åˆ†æå®Œæˆï¼', totalFrames, totalFrames, 0);
        setTimeout(() => displayResults(), 500);

      } catch (error) {
        console.error('å¤„ç†é”™è¯¯:', error);
        alert('å¤„ç†å¤±è´¥: ' + error.message);
      } finally {
        analyzeBtn.disabled = false;
      }
    });

    // æå–è§†é¢‘å¸§
    async function extractFrames() {
      return new Promise((resolve, reject) => {
        const file = videoInput.files[0];
        const mode = document.getElementById('extractMode').value;
        const frames = [];

        videoPreview.src = URL.createObjectURL(file);

        videoPreview.onloadedmetadata = () => {
          const duration = videoPreview.duration;
          
          if (mode === 'fixed') {
            // å›ºå®šé—´éš”æ¨¡å¼
            extractFramesFixed(duration, frames, resolve, reject);
          } else {
            // æ™ºèƒ½åˆ†é•œæ¨¡å¼
            extractFramesSmart(duration, frames, resolve, reject);
          }
        };
      });
    }

    // å›ºå®šé—´éš”æ¨¡å¼æå–
    function extractFramesFixed(duration, frames, resolve, reject) {
      const frameInterval = parseFloat(document.getElementById('frameInterval').value);
      const frameCount = Math.floor(duration / frameInterval);
      let currentFrameIndex = 0;

      const captureFrame = () => {
        if (currentFrameIndex >= frameCount) {
          resolve(frames);
          return;
        }

        const timestamp = currentFrameIndex * frameInterval;
        videoPreview.currentTime = timestamp;
      };

      videoPreview.onseeked = () => {
        canvas.width = videoPreview.videoWidth;
        canvas.height = videoPreview.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoPreview, 0, 0);

        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
        frames.push({
          timestamp: videoPreview.currentTime,
          dataUrl: dataUrl,
          frameIndex: currentFrameIndex
        });

        currentFrameIndex++;
        captureFrame();
      };

      videoPreview.onerror = () => reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
      captureFrame();
    }

    // æ™ºèƒ½åˆ†é•œæ¨¡å¼æå–
    function extractFramesSmart(duration, frames, resolve, reject) {
      const sensitivity = document.getElementById('sceneSensitivity').value;
      const qualityThreshold = parseFloat(document.getElementById('qualityThreshold').value);
      const minInterval = parseFloat(document.getElementById('minSceneInterval').value);
      
      // æ•æ„Ÿåº¦å¯¹åº”çš„å˜åŒ–é˜ˆå€¼
      const changeThresholds = {
        low: 35,
        medium: 25,
        high: 15
      };
      const changeThreshold = changeThresholds[sensitivity];
      
      // é‡‡æ ·é—´éš”ï¼ˆç§’ï¼‰- ç”¨äºæ£€æµ‹é•œå¤´å˜åŒ–
      const sampleInterval = 0.5;
      const totalSamples = Math.floor(duration / sampleInterval);
      
      let currentSampleIndex = 0;
      let previousFrameData = null;
      let lastCapturedTime = -minInterval;
      let sceneCount = 0;

      const processSample = () => {
        if (currentSampleIndex >= totalSamples) {
          console.log(`æ™ºèƒ½åˆ†é•œå®Œæˆ: å…±æå– ${frames.length} ä¸ªåˆ†é•œ`);
          resolve(frames);
          return;
        }

        const timestamp = currentSampleIndex * sampleInterval;
        videoPreview.currentTime = timestamp;
      };

      videoPreview.onseeked = () => {
        canvas.width = videoPreview.videoWidth;
        canvas.height = videoPreview.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoPreview, 0, 0);

        // è·å–å½“å‰å¸§çš„å›¾åƒæ•°æ®
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // è®¡ç®—ç”»é¢è´¨é‡åˆ†æ•°
        const quality = calculateFrameQuality(imageData);
        
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ•è·è¿™ä¸€å¸§
        let shouldCapture = false;
        let reason = '';

        if (quality < qualityThreshold) {
          // è´¨é‡å¤ªä½ï¼Œè·³è¿‡ï¼ˆå…¨é»‘ã€å…¨ç™½ã€æ¨¡ç³Šç­‰ï¼‰
          reason = 'è´¨é‡è¿‡ä½';
        } else if (previousFrameData === null) {
          // ç¬¬ä¸€å¸§ï¼Œç›´æ¥æ•è·
          shouldCapture = true;
          reason = 'é¦–å¸§';
        } else {
          // è®¡ç®—ä¸å‰ä¸€å¸§çš„å·®å¼‚
          const difference = calculateFrameDifference(previousFrameData, imageData);
          
          // æ£€æµ‹é•œå¤´åˆ‡æ¢
          if (difference > changeThreshold) {
            const timeSinceLastCapture = videoPreview.currentTime - lastCapturedTime;
            
            if (timeSinceLastCapture >= minInterval) {
              shouldCapture = true;
              reason = `é•œå¤´åˆ‡æ¢ (å·®å¼‚: ${difference.toFixed(1)}%)`;
            } else {
              reason = `é—´éš”å¤ªè¿‘ (${timeSinceLastCapture.toFixed(1)}s)`;
            }
          }
        }

        // æ•è·å¸§
        if (shouldCapture) {
          const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
          sceneCount++;
          
          frames.push({
            timestamp: videoPreview.currentTime,
            dataUrl: dataUrl,
            frameIndex: currentSampleIndex,
            sceneNumber: sceneCount,
            quality: quality,
            reason: reason
          });

          lastCapturedTime = videoPreview.currentTime;
          previousFrameData = imageData;
          
          console.log(`âœ“ åˆ†é•œ${sceneCount} @ ${formatTime(videoPreview.currentTime)} - ${reason}, è´¨é‡: ${quality.toFixed(1)}`);
        } else {
          // console.log(`âœ— è·³è¿‡ @ ${formatTime(videoPreview.currentTime)} - ${reason}, è´¨é‡: ${quality.toFixed(1)}`);
        }

        currentSampleIndex++;
        processSample();
      };

      videoPreview.onerror = () => reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
      processSample();
    }

    // è®¡ç®—ç”»é¢è´¨é‡åˆ†æ•°ï¼ˆ0-100ï¼‰
    function calculateFrameQuality(imageData) {
      const data = imageData.data;
      const pixels = data.length / 4;
      
      let brightness = 0;
      let variance = 0;
      let edgeCount = 0;
      
      // è®¡ç®—å¹³å‡äº®åº¦
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const luma = 0.299 * r + 0.587 * g + 0.114 * b;
        brightness += luma;
      }
      brightness /= pixels;
      
      // æ£€æµ‹å…¨é»‘æˆ–å…¨ç™½
      if (brightness < 10) return 0; // å…¨é»‘
      if (brightness > 245) return 0; // å…¨ç™½
      
      // è®¡ç®—äº®åº¦æ–¹å·®ï¼ˆå†…å®¹ä¸°å¯Œåº¦ï¼‰
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const luma = 0.299 * r + 0.587 * g + 0.114 * b;
        variance += Math.pow(luma - brightness, 2);
      }
      variance = Math.sqrt(variance / pixels);
      
      // ç®€å•è¾¹ç¼˜æ£€æµ‹ï¼ˆæ¯éš”10ä¸ªåƒç´ é‡‡æ ·ï¼‰
      const width = imageData.width;
      for (let i = 0; i < data.length - width * 4 - 4; i += 40) {
        const current = data[i];
        const right = data[i + 4];
        const down = data[i + width * 4];
        
        if (Math.abs(current - right) > 30 || Math.abs(current - down) > 30) {
          edgeCount++;
        }
      }
      
      // ç»¼åˆè¯„åˆ†
      const varianceScore = Math.min(variance / 80 * 50, 50); // æ–¹å·®è´¡çŒ®50åˆ†
      const edgeScore = Math.min(edgeCount / 100 * 50, 50);   // è¾¹ç¼˜è´¡çŒ®50åˆ†
      
      return varianceScore + edgeScore;
    }

    // è®¡ç®—ä¸¤å¸§ä¹‹é—´çš„å·®å¼‚ï¼ˆç™¾åˆ†æ¯”ï¼‰
    function calculateFrameDifference(imageData1, imageData2) {
      const data1 = imageData1.data;
      const data2 = imageData2.data;
      
      let totalDifference = 0;
      const sampleRate = 10; // æ¯éš”10ä¸ªåƒç´ é‡‡æ ·ï¼Œæé«˜æ€§èƒ½
      
      for (let i = 0; i < data1.length; i += 4 * sampleRate) {
        const r1 = data1[i];
        const g1 = data1[i + 1];
        const b1 = data1[i + 2];
        
        const r2 = data2[i];
        const g2 = data2[i + 1];
        const b2 = data2[i + 2];
        
        const diff = Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2);
        totalDifference += diff;
      }
      
      const samples = data1.length / 4 / sampleRate;
      const avgDifference = totalDifference / samples;
      
      // å½’ä¸€åŒ–åˆ°0-100
      return (avgDifference / (255 * 3)) * 100;
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      const ms = Math.floor((seconds % 1) * 10);
      return `${mins}:${secs.toString().padStart(2, '0')}.${ms}`;
    }

    // AIåˆ†æå•å¸§
    async function analyzeFrame(imageDataUrl, config) {
      if (config.provider === 'qwen') {
        return await analyzeWithQwen(imageDataUrl, config);
      } else if (config.provider === 'volcengine') {
        return await analyzeWithVolcEngine(imageDataUrl, config);
      }
      throw new Error('ä¸æ”¯æŒçš„AIå¹³å°');
    }

    // åƒé—®åˆ†æ
    async function analyzeWithQwen(imageDataUrl, config) {
      try {
        // åˆ¤æ–­æ˜¯ä½¿ç”¨å®˜æ–¹APIè¿˜æ˜¯è‡ªå»ºAPI
        const isCustomEndpoint = config.baseUrl && config.baseUrl.trim() !== '';
        
        let response, data;
        
        if (isCustomEndpoint) {
          // è‡ªå»ºAPI - ä½¿ç”¨OpenAIå…¼å®¹æ ¼å¼
          response = await fetch(config.baseUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${config.apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: config.model,
              messages: [
                {
                  role: 'system',
                  content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†è§‰åˆ†æä¸“å®¶ã€‚'
                },
                {
                  role: 'user',
                  content: [
                    {
                      type: 'image_url',
                      image_url: { url: imageDataUrl }
                    },
                    {
                      type: 'text',
                      text: 'è¯·è¯¦ç»†åˆ†æè¿™ä¸ªç”»é¢ï¼Œè¾“å‡ºã€ä¸­æ–‡ç‰ˆã€‘å’Œã€è‹±æ–‡ç‰ˆã€‘ä¸¤ä¸ªç‰ˆæœ¬ï¼Œç”¨äºAIè§†é¢‘/å›¾ç‰‡ç”Ÿæˆã€‚æ ¼å¼å¦‚ä¸‹ï¼š\n\n=== ä¸­æ–‡ç‰ˆ ===\n\nã€æ–‡ç”Ÿå›¾æç¤ºè¯ã€‘\nè¯¦ç»†æè¿°åœºæ™¯ã€äººç‰©ã€æœé¥°ã€åŠ¨ä½œã€å…‰çº¿ã€è‰²å½©ã€æ°›å›´ã€æ„å›¾ã€è§†è§’ç­‰ï¼Œç”¨ä¸“ä¸šæ‘„å½±æœ¯è¯­\n\nã€åŠ¨æ•ˆæç¤ºè¯ã€‘\næè¿°ç”»é¢ä¸­çš„åŠ¨æ€å…ƒç´ ï¼šäººç‰©è¡¨æƒ…å˜åŒ–ã€è‚¢ä½“å¾®åŠ¨ä½œã€å¤´å‘/è¡£ç‰©é£˜åŠ¨ã€çœ¼ç¥è½¬ç§»ã€å‘¼å¸èµ·ä¼ã€ç¯å¢ƒå…ƒç´ ï¼ˆé›¨/é›ª/å…‰å½±ï¼‰å˜åŒ–ç­‰ã€‚ä¾‹å¦‚ï¼š"çœ¼ç¥ç¼“ç¼“ä»è¿‘å¤„ç§»å‘è¿œæ–¹ï¼Œç›®å…‰é€æ¸å˜å¾—ç©ºçµæ‚ è¿œï¼Œè½»è½»å¹æ¯ï¼Œå˜´å”‡å¾®å¾®å¼€åˆï¼Œå‘ä¸éšé£è½»æ‰¬é£˜åŠ¨ï¼Œè€³é¥°å¾®å¾®æ‘‡æ™ƒï¼Œæ·±å‘¼å¸èµ·ä¼ï¼Œé›ªèŠ±ä»çœ¼å‰ç¼“ç¼“é£˜è¿‡ï¼Œ5ç§’æ¸å˜å¾ªç¯"\n\nã€åŸºç¡€å‚æ•°ã€‘\nresolution=3840x2160, fps=60, duration=5s, stabilization=3\n\nã€è¿é•œæ§åˆ¶ã€‘\ntype=[æ¨è¿›push_in/æ‹‰è¿œzoom_out/å·¦æ—‹pan_left/å³æ—‹pan_right/ä¸Šæ‘‡tilt_up/ä¸‹æ‘‡tilt_down/å¹³ç§»track/å›ºå®šstatic/ç¯ç»•orbit], speed=[0.5-2.0], focus_point=(x,y), angle=[è§’åº¦], scale=[ç¼©æ”¾]\n\nã€ç”»é¢çº¦æŸã€‘\nfov=[è§†åœºè§’]Â°, motion_blur=[0-1], target_ratio=[ä¸»ä½“å æ¯”]%, depth_of_field=[0-1]\n\n=== è‹±æ–‡ç‰ˆ ===\n\nã€Image Generation Promptã€‘\nDetailed scene description in English...\n\nã€Motion Effect Promptã€‘\nDescribe dynamic elements in English...\n\nã€Technical Parametersã€‘\nresolution=3840x2160, fps=60, duration=5s, stabilization=3\n\nã€Camera Controlã€‘\ntype=[push_in/zoom_out/pan_left/pan_right/tilt_up/tilt_down/track/static/orbit], speed=[0.5-2.0], focus_point=(x,y), angle=[degrees], scale=[zoom]\n\nã€Visual Constraintsã€‘\nfov=[degrees]Â°, motion_blur=[0-1], target_ratio=[percent]%, depth_of_field=[0-1]'
                    }
                  ]
                }
              ],
              max_tokens: 2000,
              temperature: 0.7
            })
          });

          data = await response.json();
          console.log('åƒé—®è‡ªå»ºAPIå“åº”:', data);

          if (data.choices && data.choices[0]) {
            return data.choices[0].message.content;
          }
        } else {
          // å®˜æ–¹API - ä½¿ç”¨åƒé—®åŸç”Ÿæ ¼å¼
          response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${config.apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: config.model,
              input: {
                messages: [
                  {
                    role: 'user',
                    content: [
                      { image: imageDataUrl },
                      { text: 'è¯·è¯¦ç»†åˆ†æè¿™ä¸ªç”»é¢ï¼Œè¾“å‡ºã€ä¸­æ–‡ç‰ˆã€‘å’Œã€è‹±æ–‡ç‰ˆã€‘ä¸¤ä¸ªç‰ˆæœ¬ï¼Œç”¨äºAIè§†é¢‘/å›¾ç‰‡ç”Ÿæˆã€‚æ ¼å¼å¦‚ä¸‹ï¼š\n\n=== ä¸­æ–‡ç‰ˆ ===\n\nã€æ–‡ç”Ÿå›¾æç¤ºè¯ã€‘\nè¯¦ç»†æè¿°åœºæ™¯ã€äººç‰©ã€æœé¥°ã€åŠ¨ä½œã€å…‰çº¿ã€è‰²å½©ã€æ°›å›´ã€æ„å›¾ã€è§†è§’ç­‰ï¼Œç”¨ä¸“ä¸šæ‘„å½±æœ¯è¯­\n\nã€åŠ¨æ•ˆæç¤ºè¯ã€‘\næè¿°ç”»é¢ä¸­çš„åŠ¨æ€å…ƒç´ ï¼šäººç‰©è¡¨æƒ…å˜åŒ–ã€è‚¢ä½“å¾®åŠ¨ä½œã€å¤´å‘/è¡£ç‰©é£˜åŠ¨ã€çœ¼ç¥è½¬ç§»ã€å‘¼å¸èµ·ä¼ã€ç¯å¢ƒå…ƒç´ ï¼ˆé›¨/é›ª/å…‰å½±ï¼‰å˜åŒ–ç­‰ã€‚ä¾‹å¦‚ï¼š"çœ¼ç¥ç¼“ç¼“ä»è¿‘å¤„ç§»å‘è¿œæ–¹ï¼Œç›®å…‰é€æ¸å˜å¾—ç©ºçµæ‚ è¿œï¼Œè½»è½»å¹æ¯ï¼Œå˜´å”‡å¾®å¾®å¼€åˆï¼Œå‘ä¸éšé£è½»æ‰¬é£˜åŠ¨ï¼Œè€³é¥°å¾®å¾®æ‘‡æ™ƒï¼Œæ·±å‘¼å¸èµ·ä¼ï¼Œé›ªèŠ±ä»çœ¼å‰ç¼“ç¼“é£˜è¿‡ï¼Œ5ç§’æ¸å˜å¾ªç¯"\n\nã€åŸºç¡€å‚æ•°ã€‘\nresolution=3840x2160, fps=60, duration=5s, stabilization=3\n\nã€è¿é•œæ§åˆ¶ã€‘\ntype=[æ¨è¿›push_in/æ‹‰è¿œzoom_out/å·¦æ—‹pan_left/å³æ—‹pan_right/ä¸Šæ‘‡tilt_up/ä¸‹æ‘‡tilt_down/å¹³ç§»track/å›ºå®šstatic/ç¯ç»•orbit], speed=[0.5-2.0], focus_point=(x,y), angle=[è§’åº¦], scale=[ç¼©æ”¾]\n\nã€ç”»é¢çº¦æŸã€‘\nfov=[è§†åœºè§’]Â°, motion_blur=[0-1], target_ratio=[ä¸»ä½“å æ¯”]%, depth_of_field=[0-1]\n\n=== è‹±æ–‡ç‰ˆ ===\n\nã€Image Generation Promptã€‘\nDetailed scene description in English...\n\nã€Motion Effect Promptã€‘\nDescribe dynamic elements in English...\n\nã€Technical Parametersã€‘\nresolution=3840x2160, fps=60, duration=5s, stabilization=3\n\nã€Camera Controlã€‘\ntype=[push_in/zoom_out/pan_left/pan_right/tilt_up/tilt_down/track/static/orbit], speed=[0.5-2.0], focus_point=(x,y), angle=[degrees], scale=[zoom]\n\nã€Visual Constraintsã€‘\nfov=[degrees]Â°, motion_blur=[0-1], target_ratio=[percent]%, depth_of_field=[0-1]' }
                    ]
                  }
                ]
              },
              parameters: {
                max_tokens: 1000
              }
            })
          });

          data = await response.json();
          console.log('åƒé—®å®˜æ–¹APIå“åº”:', data);

          if (data.output && data.output.choices && data.output.choices[0]) {
            const content = data.output.choices[0].message.content;
            // å¤„ç†ä¸åŒçš„contentæ ¼å¼
            if (Array.isArray(content)) {
              return content.find(item => item.text)?.text || 'æ— æ³•è·å–åˆ†æç»“æœ';
            } else if (typeof content === 'string') {
              return content;
            }
          }
        }

        throw new Error(data.error?.message || data.message || 'åƒé—®APIè¿”å›æ ¼å¼é”™è¯¯');
      } catch (error) {
        // æ£€æµ‹CORSé”™è¯¯
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          document.getElementById('corsWarning').style.display = 'block';
          document.getElementById('corsWarning').scrollIntoView({ behavior: 'smooth', block: 'center' });
          throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šè¯·é€šè¿‡HTTPæœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢ï¼ˆè§ä¸Šæ–¹é»„è‰²æç¤ºæ¡†ï¼‰');
        }
        throw error;
      }
    }

    // ç«å±±å¼•æ“åˆ†æ
    async function analyzeWithVolcEngine(imageDataUrl, config) {
      try {
        const response = await fetch(`${config.baseUrl}/chat/completions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${config.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: config.model,
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'image_url',
                    image_url: { url: imageDataUrl }
                  },
                  {
                    type: 'text',
                    text: 'è¯·è¯¦ç»†åˆ†æè¿™ä¸ªç”»é¢ï¼Œè¾“å‡ºã€ä¸­æ–‡ç‰ˆã€‘å’Œã€è‹±æ–‡ç‰ˆã€‘ä¸¤ä¸ªç‰ˆæœ¬ï¼Œç”¨äºAIè§†é¢‘/å›¾ç‰‡ç”Ÿæˆã€‚æ ¼å¼å¦‚ä¸‹ï¼š\n\n=== ä¸­æ–‡ç‰ˆ ===\n\nã€æ–‡ç”Ÿå›¾æç¤ºè¯ã€‘\nè¯¦ç»†æè¿°åœºæ™¯ã€äººç‰©ã€æœé¥°ã€åŠ¨ä½œã€å…‰çº¿ã€è‰²å½©ã€æ°›å›´ã€æ„å›¾ã€è§†è§’ç­‰ï¼Œç”¨ä¸“ä¸šæ‘„å½±æœ¯è¯­\n\nã€åŠ¨æ•ˆæç¤ºè¯ã€‘\næè¿°ç”»é¢ä¸­çš„åŠ¨æ€å…ƒç´ ï¼šäººç‰©è¡¨æƒ…å˜åŒ–ã€è‚¢ä½“å¾®åŠ¨ä½œã€å¤´å‘/è¡£ç‰©é£˜åŠ¨ã€çœ¼ç¥è½¬ç§»ã€å‘¼å¸èµ·ä¼ã€ç¯å¢ƒå…ƒç´ ï¼ˆé›¨/é›ª/å…‰å½±ï¼‰å˜åŒ–ç­‰ã€‚ä¾‹å¦‚ï¼š"çœ¼ç¥ç¼“ç¼“ä»è¿‘å¤„ç§»å‘è¿œæ–¹ï¼Œç›®å…‰é€æ¸å˜å¾—ç©ºçµæ‚ è¿œï¼Œè½»è½»å¹æ¯ï¼Œå˜´å”‡å¾®å¾®å¼€åˆï¼Œå‘ä¸éšé£è½»æ‰¬é£˜åŠ¨ï¼Œè€³é¥°å¾®å¾®æ‘‡æ™ƒï¼Œæ·±å‘¼å¸èµ·ä¼ï¼Œé›ªèŠ±ä»çœ¼å‰ç¼“ç¼“é£˜è¿‡ï¼Œ5ç§’æ¸å˜å¾ªç¯"\n\nã€åŸºç¡€å‚æ•°ã€‘\nresolution=3840x2160, fps=60, duration=5s, stabilization=3\n\nã€è¿é•œæ§åˆ¶ã€‘\ntype=[æ¨è¿›push_in/æ‹‰è¿œzoom_out/å·¦æ—‹pan_left/å³æ—‹pan_right/ä¸Šæ‘‡tilt_up/ä¸‹æ‘‡tilt_down/å¹³ç§»track/å›ºå®šstatic/ç¯ç»•orbit], speed=[0.5-2.0], focus_point=(x,y), angle=[è§’åº¦], scale=[ç¼©æ”¾]\n\nã€ç”»é¢çº¦æŸã€‘\nfov=[è§†åœºè§’]Â°, motion_blur=[0-1], target_ratio=[ä¸»ä½“å æ¯”]%, depth_of_field=[0-1]\n\n=== è‹±æ–‡ç‰ˆ ===\n\nã€Image Generation Promptã€‘\nDetailed scene description in English...\n\nã€Motion Effect Promptã€‘\nDescribe dynamic elements in English...\n\nã€Technical Parametersã€‘\nresolution=3840x2160, fps=60, duration=5s, stabilization=3\n\nã€Camera Controlã€‘\ntype=[push_in/zoom_out/pan_left/pan_right/tilt_up/tilt_down/track/static/orbit], speed=[0.5-2.0], focus_point=(x,y), angle=[degrees], scale=[zoom]\n\nã€Visual Constraintsã€‘\nfov=[degrees]Â°, motion_blur=[0-1], target_ratio=[percent]%, depth_of_field=[0-1]'
                  }
                ]
              }
            ],
            max_tokens: 1000,
            temperature: 0.7
          })
        });

        const data = await response.json();
        console.log('ç«å±±å¼•æ“APIå“åº”:', data);

        if (data.choices && data.choices[0]) {
          return data.choices[0].message.content;
        }

        throw new Error(data.error?.message || 'ç«å±±å¼•æ“APIè¿”å›æ ¼å¼é”™è¯¯');
      } catch (error) {
        // æ£€æµ‹CORSé”™è¯¯
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          document.getElementById('corsWarning').style.display = 'block';
          document.getElementById('corsWarning').scrollIntoView({ behavior: 'smooth', block: 'center' });
          throw new Error('CORSè·¨åŸŸé”™è¯¯ï¼šè¯·é€šè¿‡HTTPæœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢ï¼ˆè§ä¸Šæ–¹é»„è‰²æç¤ºæ¡†ï¼‰');
        }
        throw error;
      }
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress(percent, status, current = 0, total = 0, remainingSeconds = null) {
      progressBarFill.style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent.toFixed(1) + '%';
      document.getElementById('progressStatus').textContent = status;
      
      if (total > 0) {
        document.getElementById('progressDetail').textContent = `å·²å®Œæˆ ${current}/${total} å¸§`;
      }
      
      if (remainingSeconds !== null && remainingSeconds > 0) {
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = Math.floor(remainingSeconds % 60);
        if (minutes > 0) {
          document.getElementById('progressTime').textContent = `é¢„è®¡å‰©ä½™: ${minutes}åˆ†${seconds}ç§’`;
        } else {
          document.getElementById('progressTime').textContent = `é¢„è®¡å‰©ä½™: ${seconds}ç§’`;
        }
      } else if (percent >= 100) {
        const totalTime = (Date.now() - processingStartTime) / 1000;
        const minutes = Math.floor(totalTime / 60);
        const seconds = Math.floor(totalTime % 60);
        document.getElementById('progressTime').textContent = `æ€»è€—æ—¶: ${minutes}åˆ†${seconds}ç§’`;
      }
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResults() {
      resultsContainer.innerHTML = '';
      const mode = document.getElementById('extractMode').value;
      
      analysisResults.forEach((item, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        
        const minutes = Math.floor(item.timestamp / 60);
        const seconds = Math.floor(item.timestamp % 60);
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const promptId = `prompt-${index}`;
        const isLongText = item.prompt.length > 200;
        
        // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
        let titleHtml = '';
        if (mode === 'smart' && item.sceneNumber) {
          titleHtml = `<h3>ğŸ¬ åˆ†é•œ ${item.sceneNumber}</h3>`;
          if (item.quality) {
            titleHtml += `<div class="timestamp">è´¨é‡è¯„åˆ†: ${item.quality.toFixed(1)} | æ—¶é—´: ${timeStr}</div>`;
          } else {
            titleHtml += `<div class="timestamp">æ—¶é—´: ${timeStr}</div>`;
          }
        } else {
          titleHtml = `<h3>å¸§ #${item.frameNumber}</h3>
                      <div class="timestamp">æ—¶é—´: ${timeStr}</div>`;
        }
        
        resultItem.innerHTML = `
          <div class="result-item-inner">
            <div class="result-item-image">
              <img src="${item.dataUrl}" alt="Frame ${item.frameNumber}">
            </div>
            <div class="result-content">
              ${titleHtml}
              <div class="prompt">
                <button class="copy-prompt-btn" onclick="copyPrompt(${index}, this)">ğŸ“‹ å¤åˆ¶</button>
                <strong>AIç”Ÿæˆæç¤ºè¯ï¼š</strong><br>
                <div class="prompt-text ${isLongText ? 'collapsed' : 'expanded'}" id="${promptId}">${item.prompt}</div>
                ${isLongText ? `<span class="expand-btn" onclick="togglePrompt('${promptId}', this)">â–¼ å±•å¼€å®Œæ•´å†…å®¹</span>` : ''}
              </div>
            </div>
          </div>
        `;
        
        resultsContainer.appendChild(resultItem);
      });

      results.style.display = 'block';
      progressSection.style.display = 'none';
      results.scrollIntoView({ behavior: 'smooth' });
    }

    // å¯¼å‡ºTXT
    exportTxtBtn.addEventListener('click', () => {
      const mode = document.getElementById('extractMode').value;
      let content = 'è§†é¢‘åˆ†æç»“æœ\n';
      content += '=' .repeat(50) + '\n';
      content += `æå–æ¨¡å¼: ${mode === 'smart' ? 'æ™ºèƒ½åˆ†é•œ' : 'å›ºå®šé—´éš”'}\n`;
      content += `æ€»å¸§æ•°: ${analysisResults.length}\n`;
      content += '=' .repeat(50) + '\n\n';
      
      analysisResults.forEach(item => {
        const minutes = Math.floor(item.timestamp / 60);
        const seconds = Math.floor(item.timestamp % 60);
        
        if (mode === 'smart' && item.sceneNumber) {
          content += `ğŸ¬ åˆ†é•œ ${item.sceneNumber} (${minutes}:${seconds.toString().padStart(2, '0')})\n`;
          if (item.quality) {
            content += `è´¨é‡è¯„åˆ†: ${item.quality.toFixed(1)}\n`;
          }
        } else {
          content += `å¸§ #${item.frameNumber} (${minutes}:${seconds.toString().padStart(2, '0')})\n`;
        }
        content += '-'.repeat(50) + '\n';
        content += item.prompt + '\n\n';
      });

      downloadFile(content, 'video-analysis.txt', 'text/plain');
    });

    // å¯¼å‡ºJSON
    exportJsonBtn.addEventListener('click', () => {
      const jsonData = JSON.stringify(analysisResults, null, 2);
      downloadFile(jsonData, 'video-analysis.json', 'application/json');
    });

    // å¤åˆ¶å…¨éƒ¨
    copyAllBtn.addEventListener('click', () => {
      let content = '';
      analysisResults.forEach(item => {
        const minutes = Math.floor(item.timestamp / 60);
        const seconds = Math.floor(item.timestamp % 60);
        content += `å¸§ #${item.frameNumber} (${minutes}:${seconds.toString().padStart(2, '0')})\n${item.prompt}\n\n`;
      });

      navigator.clipboard.writeText(content).then(() => {
        alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      });
    });

    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type: type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // åˆ‡æ¢æç¤ºè¯å±•å¼€/æ”¶èµ·
    function togglePrompt(promptId, button) {
      const promptElement = document.getElementById(promptId);
      const isCollapsed = promptElement.classList.contains('collapsed');
      
      if (isCollapsed) {
        promptElement.classList.remove('collapsed');
        promptElement.classList.add('expanded');
        button.innerHTML = 'â–² æ”¶èµ·';
      } else {
        promptElement.classList.remove('expanded');
        promptElement.classList.add('collapsed');
        button.innerHTML = 'â–¼ å±•å¼€æ›´å¤š';
      }
    }

    // å¤åˆ¶å•ä¸ªprompt
    function copyPrompt(index, button) {
      const prompt = analysisResults[index].prompt;
      
      navigator.clipboard.writeText(prompt).then(() => {
        // ä¿®æ”¹æŒ‰é’®æ–‡å­—å’Œæ ·å¼
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… å·²å¤åˆ¶';
        button.classList.add('copied');
        
        // 2ç§’åæ¢å¤
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
      });
    }
  </script>
</body>
</html>
